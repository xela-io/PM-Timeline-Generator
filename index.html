<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timeline Generator</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        [v-cloak] { display: none; }
        .phase-bar { transition: all 0.2s ease; }
        .phase-bar:hover { filter: brightness(1.1); cursor: pointer; }
        .milestone-icon { transition: transform 0.2s ease; }
        .milestone-icon:hover { transform: scale(1.1); cursor: pointer; }
        .row-hover:hover { background-color: rgba(0,0,0,0.02); }
        .grid-line { stroke: #D1D5DB; stroke-width: 1; }
        .grid-line-light { stroke: #E5E7EB; stroke-width: 0.5; }

        /* Gestrichelte Puffer-Linie */
        .buffer-line {
            stroke-dasharray: 8, 4;
            stroke-width: 3;
            fill: none;
        }

        /* Kritischer Pfad Markierung */
        .critical-marker {
            stroke: #991B1B;
            stroke-width: 2;
        }

        /* Heute-Linie */
        .today-line {
            stroke: #1F2937;
            stroke-width: 2;
        }

        /* Drag & Drop Styles */
        .draggable-item {
            cursor: grab;
            transition: all 0.2s ease;
        }
        .draggable-item:active { cursor: grabbing; }
        .draggable-item.dragging {
            opacity: 0.5;
            transform: scale(0.98);
        }
        .draggable-item.drag-over {
            border-color: #3B82F6 !important;
            border-style: dashed !important;
            background-color: #EFF6FF !important;
        }
        .drag-handle {
            cursor: grab;
            color: #9CA3AF;
            user-select: none;
        }
        .drag-handle:hover { color: #6B7280; }

        /* Panel Resize Handle */
        .resize-handle {
            width: 6px;
            cursor: col-resize;
            background: transparent;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }
        .resize-handle:hover,
        .resize-handle.resizing {
            background-color: #3B82F6;
        }
        .resize-handle::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 2px;
            height: 30px;
            background: #D1D5DB;
            border-radius: 1px;
        }
        .resize-handle:hover::after {
            background: white;
        }
        .drag-handle:active { cursor: grabbing; }

        /* Print/Export Styles */
        @media print {
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app" v-cloak>
        <div class="flex h-screen">
            <!-- Sidebar -->
            <aside class="w-64 bg-white border-r border-gray-200 flex flex-col no-print">
                <div class="p-4 border-b border-gray-200">
                    <h1 class="text-xl font-semibold text-gray-800">Timeline Generator</h1>
                </div>

                <!-- Projektliste -->
                <div class="flex-1 overflow-y-auto p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h2 class="text-sm font-medium text-gray-600">Projekte</h2>
                        <button @click="createProject" class="text-blue-600 hover:text-blue-800 text-sm font-medium">+ Neu</button>
                    </div>
                    <div class="space-y-1">
                        <div v-for="project in projects" :key="project.id"
                             @click="selectProject(project.id)"
                             :class="['p-2 rounded cursor-pointer text-sm',
                                      currentProject?.id === project.id ? 'bg-blue-50 text-blue-700 border border-blue-200' : 'hover:bg-gray-50 text-gray-700']">
                            <div class="font-medium truncate">{{ project.projekt.name }}</div>
                            <div class="text-xs text-gray-500">{{ formatDateShort(project.projekt.start) }} - {{ formatDateShort(project.projekt.ende) }}</div>
                        </div>
                        <div v-if="projects.length === 0" class="text-gray-400 text-sm p-2">
                            Keine Projekte vorhanden
                        </div>
                    </div>
                </div>

                <!-- Projekt-Aktionen -->
                <div v-if="currentProject" class="p-4 border-t border-gray-200 space-y-1">
                    <button @click="duplicateProject" class="w-full text-left text-sm text-gray-600 hover:text-gray-800 p-2 hover:bg-gray-50 rounded">
                        Duplizieren
                    </button>
                    <button @click="saveAsTemplate" class="w-full text-left text-sm text-gray-600 hover:text-gray-800 p-2 hover:bg-gray-50 rounded">
                        Als Vorlage speichern
                    </button>
                    <button @click="deleteProject" class="w-full text-left text-sm text-red-500 hover:text-red-700 p-2 hover:bg-red-50 rounded">
                        Löschen
                    </button>
                </div>

                <!-- Vorlagen -->
                <div class="p-4 border-t border-gray-200">
                    <div class="flex items-center justify-between mb-2">
                        <h2 class="text-sm font-medium text-gray-600">Vorlagen</h2>
                        <button @click="showTemplatesModal = true" class="text-gray-400 hover:text-gray-600 text-xs">Verwalten</button>
                    </div>
                    <div class="space-y-1">
                        <div v-for="template in templates" :key="template.id"
                             @click="createFromTemplate(template)"
                             class="p-2 rounded cursor-pointer text-sm hover:bg-green-50 text-gray-600 hover:text-green-700 border border-dashed border-gray-300 hover:border-green-400">
                            <div class="flex items-center space-x-2">
                                <span class="text-green-600">+</span>
                                <span class="truncate">{{ template.name }}</span>
                            </div>
                        </div>
                        <div v-if="templates.length === 0" class="text-gray-400 text-xs p-2">
                            Keine Vorlagen gespeichert
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 flex flex-col overflow-hidden">
                <!-- Toolbar -->
                <header class="bg-white border-b border-gray-200 p-4 flex items-center justify-between no-print">
                    <div class="flex items-center space-x-4">
                        <select v-model="activeTab" class="border border-gray-300 rounded px-3 py-1.5 text-sm bg-white">
                            <option value="projekt">Projekt</option>
                            <option value="gruppen">Gruppen</option>
                            <option value="elemente">Phasen & Meilensteine</option>
                        </select>
                        <div class="flex items-center space-x-2" v-if="currentProject">
                            <label class="text-sm text-gray-600">Zeitskala:</label>
                            <select v-model="currentProject.einstellungen.zeitskala" @change="saveToStorage" class="border border-gray-300 rounded px-2 py-1 text-sm bg-white">
                                <option value="monat">Monate</option>
                                <option value="quartal">Quartale</option>
                            </select>
                        </div>
                        <div class="flex items-center space-x-2 border-l pl-2 ml-2" v-if="currentProject">
                            <button @click="darkMode = !darkMode"
                                    :class="darkMode ? 'bg-gray-700 text-yellow-300' : 'bg-gray-100 text-gray-600'"
                                    class="px-2 py-1 rounded text-sm hover:opacity-80 flex items-center space-x-1"
                                    :title="darkMode ? 'Helles Theme' : 'Dunkles Theme'">
                                <span v-if="darkMode">&#9788;</span>
                                <span v-else>&#9790;</span>
                            </button>
                            <button @click="showExecutiveSummary = !showExecutiveSummary"
                                    :class="showExecutiveSummary ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-600'"
                                    class="px-2 py-1 rounded text-sm hover:opacity-80"
                                    title="Executive Summary - Nur Hauptelemente">
                                Exec
                            </button>
                            <button @click="verticalMode = !verticalMode"
                                    :class="verticalMode ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-600'"
                                    class="px-2 py-1 rounded text-sm hover:opacity-80"
                                    title="Vertikale Roadmap">
                                {{ verticalMode ? '↔' : '↕' }}
                            </button>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button @click="showExportModal = true" class="bg-red-700 text-white px-4 py-1.5 rounded text-sm hover:bg-red-800 font-medium">
                            Export
                        </button>
                        <button @click="showImportExportModal = true" class="border border-gray-300 px-3 py-1.5 rounded text-sm hover:bg-gray-50">
                            JSON
                        </button>
                    </div>
                </header>

                <div v-if="!currentProject" class="flex-1 flex items-center justify-center text-gray-400">
                    <div class="text-center">
                        <p class="text-lg mb-4">Kein Projekt ausgewählt</p>
                        <button @click="createProject" class="text-blue-600 hover:text-blue-800 font-medium">+ Neues Projekt erstellen</button>
                    </div>
                </div>

                <div v-else class="flex-1 flex overflow-hidden">
                    <!-- Editor Panel -->
                    <div class="sidebar-width border-r border-gray-200 bg-white overflow-y-auto p-4 no-print flex-shrink-0"
                         :style="{ width: editorPanelWidth + 'px' }">
                        <!-- Projekt Tab -->
                        <div v-if="activeTab === 'projekt'" class="space-y-4">
                            <h3 class="font-semibold text-gray-800">Projekt-Einstellungen</h3>
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">Projektname</label>
                                <input v-model="currentProject.projekt.name" @input="saveToStorage" type="text" class="w-full border border-gray-300 rounded px-3 py-2 text-sm">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">Beschreibung</label>
                                <textarea v-model="currentProject.projekt.beschreibung" @input="saveToStorage" rows="2" class="w-full border border-gray-300 rounded px-3 py-2 text-sm"></textarea>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">Projektstart</label>
                                    <input v-model="currentProject.projekt.start" @input="saveToStorage" type="date" class="w-full border border-gray-300 rounded px-3 py-2 text-sm">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">Projektende</label>
                                    <input v-model="currentProject.projekt.ende" @input="saveToStorage" type="date" class="w-full border border-gray-300 rounded px-3 py-2 text-sm">
                                </div>
                            </div>
                            <div class="pt-2 space-y-2">
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" v-model="currentProject.einstellungen.heuteAnzeigen" @change="saveToStorage" class="rounded">
                                    <span class="text-sm text-gray-600">Heute-Linie anzeigen</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" v-model="currentProject.einstellungen.legendeAnzeigen" @change="saveToStorage" class="rounded">
                                    <span class="text-sm text-gray-600">Legende anzeigen</span>
                                </label>
                            </div>

                            <!-- Farb-Kategorien -->
                            <div class="pt-4 border-t border-gray-200">
                                <h4 class="text-sm font-medium text-gray-700 mb-3">Farb-Kategorien</h4>
                                <div class="space-y-2">
                                    <div class="flex items-center space-x-2">
                                        <div class="w-6 h-6 rounded" style="background-color: #166534;"></div>
                                        <input v-model="currentProject.einstellungen.farbNamen.gruen" @input="saveToStorage"
                                               type="text" placeholder="Name für Grün"
                                               class="flex-1 border border-gray-300 rounded px-2 py-1 text-sm">
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <div class="w-6 h-6 rounded" style="background-color: #991B1B;"></div>
                                        <input v-model="currentProject.einstellungen.farbNamen.rot" @input="saveToStorage"
                                               type="text" placeholder="Name für Rot"
                                               class="flex-1 border border-gray-300 rounded px-2 py-1 text-sm">
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <div class="w-6 h-6 rounded" style="background-color: #450a0a;"></div>
                                        <input v-model="currentProject.einstellungen.farbNamen.dunkelrot" @input="saveToStorage"
                                               type="text" placeholder="Name für Dunkelrot"
                                               class="flex-1 border border-gray-300 rounded px-2 py-1 text-sm">
                                    </div>
                                </div>
                                <p class="text-xs text-gray-500 mt-2">Diese Namen erscheinen in der Legende.</p>
                            </div>
                        </div>

                        <!-- Gruppen Tab -->
                        <div v-if="activeTab === 'gruppen'" class="space-y-4">
                            <div class="flex items-center justify-between">
                                <h3 class="font-semibold text-gray-800">Gruppen</h3>
                                <button @click="addGruppe" class="text-blue-600 hover:text-blue-800 text-sm font-medium">+ Gruppe</button>
                            </div>
                            <p class="text-xs text-gray-500">Gruppen sind Überschriften, die Phasen und Meilensteine organisieren.</p>
                            <div class="space-y-2">
                                <div v-for="(gruppe, index) in sortedGruppen" :key="gruppe.id"
                                     class="border border-gray-200 rounded p-3 bg-gray-50">
                                    <div class="flex items-center space-x-2 mb-2">
                                        <input v-model="gruppe.name" @input="saveToStorage" type="text" placeholder="Gruppenname" class="flex-1 border border-gray-300 rounded px-2 py-1.5 text-sm font-medium">
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center space-x-1">
                                            <button @click="moveGruppe(gruppe, -1)" :disabled="index === 0" class="text-gray-400 hover:text-gray-600 disabled:opacity-30 p-1 text-sm">↑</button>
                                            <button @click="moveGruppe(gruppe, 1)" :disabled="index === sortedGruppen.length - 1" class="text-gray-400 hover:text-gray-600 disabled:opacity-30 p-1 text-sm">↓</button>
                                        </div>
                                        <button @click="deleteGruppe(gruppe.id)" class="text-red-400 hover:text-red-600 text-xs">Löschen</button>
                                    </div>
                                </div>
                                <div v-if="currentProject.gruppen.length === 0" class="text-gray-400 text-sm p-2 text-center">
                                    Keine Gruppen vorhanden
                                </div>
                            </div>
                        </div>

                        <!-- Elemente Tab -->
                        <div v-if="activeTab === 'elemente'" class="space-y-3">
                            <!-- Header mit Ansichts-Umschalter -->
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <h3 class="font-semibold text-gray-800">Elemente</h3>
                                    <div class="flex border border-gray-300 rounded overflow-hidden text-xs">
                                        <button @click="elementeView = 'kompakt'"
                                                :class="['px-2 py-1', elementeView === 'kompakt' ? 'bg-gray-700 text-white' : 'bg-white text-gray-600 hover:bg-gray-100']">
                                            Liste
                                        </button>
                                        <button @click="elementeView = 'tabelle'"
                                                :class="['px-2 py-1', elementeView === 'tabelle' ? 'bg-gray-700 text-white' : 'bg-white text-gray-600 hover:bg-gray-100']">
                                            Tabelle
                                        </button>
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    <button @click="addElement('phase')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">+ Phase</button>
                                    <button @click="addElement('meilenstein')" class="text-green-600 hover:text-green-800 text-sm font-medium">+ MS</button>
                                    <button @click="openBatchInput" class="text-purple-600 hover:text-purple-800 text-sm font-medium border-l border-gray-300 pl-2">+ Mehrere</button>
                                </div>
                            </div>

                            <!-- KOMPAKTE LISTENANSICHT -->
                            <div v-if="elementeView === 'kompakt'">
                                <!-- Gruppen mit Elementen -->
                                <div v-for="gruppe in sortedGruppen" :key="'grp-' + gruppe.id" class="mb-3">
                                    <!-- Gruppen-Header (klappbar) -->
                                    <div @click="toggleGroupCollapse(gruppe.id)"
                                         class="flex items-center justify-between bg-gray-100 px-2 py-1.5 rounded cursor-pointer hover:bg-gray-200">
                                        <div class="flex items-center space-x-2">
                                            <span class="text-gray-500 text-xs">{{ isGroupCollapsed(gruppe.id) ? '▶' : '▼' }}</span>
                                            <span class="text-sm font-semibold text-gray-700">{{ gruppe.name }}</span>
                                            <span class="text-xs text-gray-400">({{ getElementeForGruppe(gruppe.id).length }})</span>
                                        </div>
                                    </div>

                                    <!-- Elemente der Gruppe -->
                                    <div v-if="!isGroupCollapsed(gruppe.id)" class="mt-1 space-y-1">
                                        <div v-for="element in getElementeForGruppe(gruppe.id)" :key="element.id"
                                             draggable="true"
                                             @dragstart="onDragStart($event, element)"
                                             @dragover="onDragOver($event, element)"
                                             @dragleave="onDragLeave($event)"
                                             @drop="onDrop($event, element)"
                                             @dragend="onDragEnd($event)"
                                             :class="['border rounded bg-white draggable-item', dragOverId === element.id ? 'drag-over' : 'border-gray-200']">

                                            <!-- Kompakte Zeile -->
                                            <div @click="toggleElementExpand(element.id)"
                                                 class="flex items-center px-2 py-1.5 cursor-pointer hover:bg-gray-50">
                                                <span class="drag-handle text-gray-400 mr-2 text-sm" @click.stop title="Ziehen">⋮⋮</span>
                                                <span class="text-gray-400 text-xs mr-2">{{ expandedElementId === element.id ? '▼' : '▶' }}</span>
                                                <div class="w-3 h-3 rounded-sm mr-2"
                                                     :style="{ backgroundColor: element.typ === 'phase' ? (element.farbe === 'gruen' ? '#166534' : element.farbe === 'dunkelrot' ? '#450a0a' : '#991B1B') : 'transparent' }"
                                                     :class="element.typ === 'meilenstein' ? 'border-2 border-amber-600 transform rotate-45' : ''"></div>
                                                <span :class="['flex-1 text-sm truncate', (element.einrueckung || 0) > 0 ? 'ml-' + (element.einrueckung * 3) : '']">
                                                    {{ element.name || '(Unbenannt)' }}
                                                </span>
                                                <span class="text-xs text-gray-400 ml-2">{{ getElementSummary(element) }}</span>
                                                <div class="flex items-center ml-2 space-x-1" @click.stop>
                                                    <button @click="moveElement(element, -1)" class="text-gray-300 hover:text-gray-600 text-xs px-1">↑</button>
                                                    <button @click="moveElement(element, 1)" class="text-gray-300 hover:text-gray-600 text-xs px-1">↓</button>
                                                </div>
                                            </div>

                                            <!-- Aufgeklappte Details -->
                                            <div v-if="expandedElementId === element.id" class="px-3 pb-3 pt-2 border-t border-gray-100 bg-gray-50">
                                                <div class="grid grid-cols-2 gap-2 mb-2">
                                                    <div>
                                                        <label class="text-xs text-gray-500">Name</label>
                                                        <input v-model="element.name" @input="saveToStorage" type="text" class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                                                    </div>
                                                    <div>
                                                        <label class="text-xs text-gray-500">Gruppe</label>
                                                        <select v-model="element.gruppe" @change="saveToStorage" class="w-full border border-gray-300 rounded px-2 py-1 text-sm bg-white">
                                                            <option value="">-- Keine --</option>
                                                            <option v-for="g in sortedGruppen" :key="g.id" :value="g.id">{{ g.name }}</option>
                                                        </select>
                                                    </div>
                                                </div>

                                                <!-- Phase-spezifisch -->
                                                <div v-if="element.typ === 'phase'">
                                                    <div class="grid grid-cols-2 gap-2 mb-2">
                                                        <div>
                                                            <label class="text-xs text-gray-500">Start</label>
                                                            <input v-model="element.start" @input="saveToStorage" type="date" class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                                                        </div>
                                                        <div>
                                                            <label class="text-xs text-gray-500">Ende</label>
                                                            <input v-model="element.ende" @input="saveToStorage" type="date" class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                                                        </div>
                                                    </div>
                                                    <div class="flex items-center flex-wrap gap-2 mb-2">
                                                        <select v-model.number="element.einrueckung" @change="saveToStorage" class="border border-gray-300 rounded px-2 py-1 text-xs bg-white">
                                                            <option :value="0">Ebene 1</option>
                                                            <option :value="1">Ebene 2</option>
                                                            <option :value="2">Ebene 3</option>
                                                        </select>
                                                        <label class="flex items-center space-x-1">
                                                            <input type="checkbox" v-model="element.kritisch" @change="saveToStorage" class="rounded">
                                                            <span class="text-xs text-gray-600">Kritisch</span>
                                                        </label>
                                                        <div class="flex items-center space-x-1">
                                                            <span class="text-xs text-gray-600">Puffer:</span>
                                                            <input v-model.number="element.pufferTage" @input="saveToStorage" type="number" min="0" class="w-12 border border-gray-300 rounded px-1 py-0.5 text-xs">
                                                        </div>
                                                    </div>
                                                    <div class="flex items-center space-x-2">
                                                        <span class="text-xs text-gray-600">Farbe:</span>
                                                        <button @click="element.farbe = 'gruen'; saveToStorage()" :class="['w-5 h-5 rounded border-2', element.farbe === 'gruen' ? 'border-gray-800' : 'border-transparent']" style="background-color: #166534;"></button>
                                                        <button @click="element.farbe = 'rot'; saveToStorage()" :class="['w-5 h-5 rounded border-2', element.farbe === 'rot' ? 'border-gray-800' : 'border-transparent']" style="background-color: #991B1B;"></button>
                                                        <button @click="element.farbe = 'dunkelrot'; saveToStorage()" :class="['w-5 h-5 rounded border-2', element.farbe === 'dunkelrot' ? 'border-gray-800' : 'border-transparent']" style="background-color: #450a0a;"></button>
                                                    </div>
                                                </div>

                                                <!-- Meilenstein-spezifisch -->
                                                <div v-if="element.typ === 'meilenstein'" class="grid grid-cols-2 gap-2">
                                                    <div>
                                                        <label class="text-xs text-gray-500">Datum</label>
                                                        <input v-model="element.datum" @input="saveToStorage" type="date" class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                                                    </div>
                                                    <div>
                                                        <label class="text-xs text-gray-500">Einrückung</label>
                                                        <select v-model.number="element.einrueckung" @change="saveToStorage" class="w-full border border-gray-300 rounded px-2 py-1 text-sm bg-white">
                                                            <option :value="0">Ebene 1</option>
                                                            <option :value="1">Ebene 2</option>
                                                            <option :value="2">Ebene 3</option>
                                                        </select>
                                                    </div>
                                                </div>

                                                <div class="flex justify-end space-x-2 mt-2 pt-2 border-t border-gray-200">
                                                    <button @click="duplicateElement(element)" class="text-blue-500 hover:text-blue-700 text-xs">Duplizieren</button>
                                                    <button @click="deleteElement(element.id)" class="text-red-500 hover:text-red-700 text-xs">Löschen</button>
                                                </div>
                                            </div>
                                        </div>
                                        <div v-if="getElementeForGruppe(gruppe.id).length === 0" class="text-gray-400 text-xs py-2 pl-6">
                                            Keine Elemente
                                        </div>
                                    </div>
                                </div>

                                <!-- Elemente ohne Gruppe -->
                                <div v-if="getElementeForGruppe('').length > 0" class="mb-3">
                                    <div @click="toggleGroupCollapse('__none__')"
                                         class="flex items-center justify-between bg-gray-50 px-2 py-1.5 rounded cursor-pointer hover:bg-gray-100">
                                        <div class="flex items-center space-x-2">
                                            <span class="text-gray-400 text-xs">{{ isGroupCollapsed('__none__') ? '▶' : '▼' }}</span>
                                            <span class="text-sm font-medium text-gray-500">Ohne Gruppe</span>
                                            <span class="text-xs text-gray-400">({{ getElementeForGruppe('').length }})</span>
                                        </div>
                                    </div>
                                    <div v-if="!isGroupCollapsed('__none__')" class="mt-1 space-y-1">
                                        <div v-for="element in getElementeForGruppe('')" :key="element.id"
                                             draggable="true"
                                             @dragstart="onDragStart($event, element)"
                                             @dragover="onDragOver($event, element)"
                                             @dragleave="onDragLeave($event)"
                                             @drop="onDrop($event, element)"
                                             @dragend="onDragEnd($event)"
                                             :class="['border rounded bg-white draggable-item', dragOverId === element.id ? 'drag-over' : 'border-gray-200']">
                                            <!-- Same compact row as above -->
                                            <div @click="toggleElementExpand(element.id)" class="flex items-center px-2 py-1.5 cursor-pointer hover:bg-gray-50">
                                                <span class="drag-handle text-gray-400 mr-2 text-sm" @click.stop>⋮⋮</span>
                                                <span class="text-gray-400 text-xs mr-2">{{ expandedElementId === element.id ? '▼' : '▶' }}</span>
                                                <div class="w-3 h-3 rounded-sm mr-2"
                                                     :style="{ backgroundColor: element.typ === 'phase' ? (element.farbe === 'gruen' ? '#166534' : element.farbe === 'dunkelrot' ? '#450a0a' : '#991B1B') : 'transparent' }"
                                                     :class="element.typ === 'meilenstein' ? 'border-2 border-amber-600 transform rotate-45' : ''"></div>
                                                <span class="flex-1 text-sm truncate">{{ element.name || '(Unbenannt)' }}</span>
                                                <span class="text-xs text-gray-400 ml-2">{{ getElementSummary(element) }}</span>
                                                <div class="flex items-center ml-2 space-x-1" @click.stop>
                                                    <button @click="moveElement(element, -1)" class="text-gray-300 hover:text-gray-600 text-xs px-1">↑</button>
                                                    <button @click="moveElement(element, 1)" class="text-gray-300 hover:text-gray-600 text-xs px-1">↓</button>
                                                </div>
                                            </div>
                                            <!-- Expanded details (same as above) -->
                                            <div v-if="expandedElementId === element.id" class="px-3 pb-3 pt-2 border-t border-gray-100 bg-gray-50">
                                                <div class="grid grid-cols-2 gap-2 mb-2">
                                                    <div>
                                                        <label class="text-xs text-gray-500">Name</label>
                                                        <input v-model="element.name" @input="saveToStorage" type="text" class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                                                    </div>
                                                    <div>
                                                        <label class="text-xs text-gray-500">Gruppe</label>
                                                        <select v-model="element.gruppe" @change="saveToStorage" class="w-full border border-gray-300 rounded px-2 py-1 text-sm bg-white">
                                                            <option value="">-- Keine --</option>
                                                            <option v-for="g in sortedGruppen" :key="g.id" :value="g.id">{{ g.name }}</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div v-if="element.typ === 'phase'">
                                                    <div class="grid grid-cols-2 gap-2 mb-2">
                                                        <div>
                                                            <label class="text-xs text-gray-500">Start</label>
                                                            <input v-model="element.start" @input="saveToStorage" type="date" class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                                                        </div>
                                                        <div>
                                                            <label class="text-xs text-gray-500">Ende</label>
                                                            <input v-model="element.ende" @input="saveToStorage" type="date" class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                                                        </div>
                                                    </div>
                                                    <div class="flex items-center flex-wrap gap-2 mb-2">
                                                        <select v-model.number="element.einrueckung" @change="saveToStorage" class="border border-gray-300 rounded px-2 py-1 text-xs bg-white">
                                                            <option :value="0">Ebene 1</option>
                                                            <option :value="1">Ebene 2</option>
                                                            <option :value="2">Ebene 3</option>
                                                        </select>
                                                        <label class="flex items-center space-x-1">
                                                            <input type="checkbox" v-model="element.kritisch" @change="saveToStorage" class="rounded">
                                                            <span class="text-xs text-gray-600">Kritisch</span>
                                                        </label>
                                                        <div class="flex items-center space-x-1">
                                                            <span class="text-xs text-gray-600">Puffer:</span>
                                                            <input v-model.number="element.pufferTage" @input="saveToStorage" type="number" min="0" class="w-12 border border-gray-300 rounded px-1 py-0.5 text-xs">
                                                        </div>
                                                    </div>
                                                    <div class="flex items-center space-x-2">
                                                        <span class="text-xs text-gray-600">Farbe:</span>
                                                        <button @click="element.farbe = 'gruen'; saveToStorage()" :class="['w-5 h-5 rounded border-2', element.farbe === 'gruen' ? 'border-gray-800' : 'border-transparent']" style="background-color: #166534;"></button>
                                                        <button @click="element.farbe = 'rot'; saveToStorage()" :class="['w-5 h-5 rounded border-2', element.farbe === 'rot' ? 'border-gray-800' : 'border-transparent']" style="background-color: #991B1B;"></button>
                                                        <button @click="element.farbe = 'dunkelrot'; saveToStorage()" :class="['w-5 h-5 rounded border-2', element.farbe === 'dunkelrot' ? 'border-gray-800' : 'border-transparent']" style="background-color: #450a0a;"></button>
                                                    </div>
                                                </div>
                                                <div v-if="element.typ === 'meilenstein'" class="grid grid-cols-2 gap-2">
                                                    <div>
                                                        <label class="text-xs text-gray-500">Datum</label>
                                                        <input v-model="element.datum" @input="saveToStorage" type="date" class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                                                    </div>
                                                    <div>
                                                        <label class="text-xs text-gray-500">Einrückung</label>
                                                        <select v-model.number="element.einrueckung" @change="saveToStorage" class="w-full border border-gray-300 rounded px-2 py-1 text-sm bg-white">
                                                            <option :value="0">Ebene 1</option>
                                                            <option :value="1">Ebene 2</option>
                                                            <option :value="2">Ebene 3</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="flex justify-end space-x-2 mt-2 pt-2 border-t border-gray-200">
                                                    <button @click="duplicateElement(element)" class="text-blue-500 hover:text-blue-700 text-xs">Duplizieren</button>
                                                    <button @click="deleteElement(element.id)" class="text-red-500 hover:text-red-700 text-xs">Löschen</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- TABELLENANSICHT -->
                            <div v-if="elementeView === 'tabelle'" class="overflow-x-auto">
                                <table class="w-full text-xs border-collapse">
                                    <thead>
                                        <tr class="bg-gray-100">
                                            <th class="text-left p-1.5 border-b border-gray-300 w-8"></th>
                                            <th class="text-left p-1.5 border-b border-gray-300">Name</th>
                                            <th class="text-left p-1.5 border-b border-gray-300 w-20">Typ</th>
                                            <th class="text-left p-1.5 border-b border-gray-300 w-24">Start</th>
                                            <th class="text-left p-1.5 border-b border-gray-300 w-24">Ende</th>
                                            <th class="text-left p-1.5 border-b border-gray-300 w-16">Farbe</th>
                                            <th class="text-left p-1.5 border-b border-gray-300 w-20">Aktionen</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <template v-for="gruppe in sortedGruppen" :key="'tbl-grp-' + gruppe.id">
                                            <tr class="bg-gray-50">
                                                <td colspan="7" class="p-1.5 font-semibold text-gray-700 border-b border-gray-200">
                                                    {{ gruppe.name }}
                                                </td>
                                            </tr>
                                            <tr v-for="element in getElementeForGruppe(gruppe.id)" :key="'tbl-' + element.id"
                                                class="hover:bg-blue-50 border-b border-gray-100"
                                                draggable="true"
                                                @dragstart="onDragStart($event, element)"
                                                @dragover="onDragOver($event, element)"
                                                @dragleave="onDragLeave($event)"
                                                @drop="onDrop($event, element)"
                                                @dragend="onDragEnd($event)">
                                                <td class="p-1 text-center">
                                                    <span class="drag-handle text-gray-400 cursor-grab">⋮⋮</span>
                                                </td>
                                                <td class="p-1">
                                                    <input v-model="element.name" @input="saveToStorage" type="text"
                                                           class="w-full border border-transparent hover:border-gray-300 focus:border-blue-400 rounded px-1 py-0.5 bg-transparent">
                                                </td>
                                                <td class="p-1">
                                                    <span :class="element.typ === 'phase' ? 'text-red-600' : 'text-amber-600'">
                                                        {{ element.typ === 'phase' ? 'Phase' : 'MS' }}
                                                    </span>
                                                </td>
                                                <td class="p-1">
                                                    <input v-if="element.typ === 'phase'" v-model="element.start" @input="saveToStorage" type="date"
                                                           class="w-full border border-transparent hover:border-gray-300 focus:border-blue-400 rounded px-1 py-0.5 bg-transparent text-xs">
                                                    <input v-else v-model="element.datum" @input="saveToStorage" type="date"
                                                           class="w-full border border-transparent hover:border-gray-300 focus:border-blue-400 rounded px-1 py-0.5 bg-transparent text-xs">
                                                </td>
                                                <td class="p-1">
                                                    <input v-if="element.typ === 'phase'" v-model="element.ende" @input="saveToStorage" type="date"
                                                           class="w-full border border-transparent hover:border-gray-300 focus:border-blue-400 rounded px-1 py-0.5 bg-transparent text-xs">
                                                    <span v-else class="text-gray-300">-</span>
                                                </td>
                                                <td class="p-1">
                                                    <div v-if="element.typ === 'phase'" class="flex space-x-1">
                                                        <button @click="element.farbe = 'gruen'; saveToStorage()" :class="['w-4 h-4 rounded', element.farbe === 'gruen' ? 'ring-2 ring-gray-800' : '']" style="background-color: #166534;"></button>
                                                        <button @click="element.farbe = 'rot'; saveToStorage()" :class="['w-4 h-4 rounded', element.farbe === 'rot' ? 'ring-2 ring-gray-800' : '']" style="background-color: #991B1B;"></button>
                                                        <button @click="element.farbe = 'dunkelrot'; saveToStorage()" :class="['w-4 h-4 rounded', element.farbe === 'dunkelrot' ? 'ring-2 ring-gray-800' : '']" style="background-color: #450a0a;"></button>
                                                    </div>
                                                    <span v-else class="text-gray-300">-</span>
                                                </td>
                                                <td class="p-1">
                                                    <div class="flex space-x-1">
                                                        <button @click="duplicateElement(element)" class="text-blue-400 hover:text-blue-600" title="Duplizieren">D</button>
                                                        <button @click="deleteElement(element.id)" class="text-red-400 hover:text-red-600" title="Löschen">X</button>
                                                    </div>
                                                </td>
                                            </tr>
                                        </template>
                                        <!-- Ohne Gruppe -->
                                        <template v-if="getElementeForGruppe('').length > 0">
                                            <tr class="bg-gray-50">
                                                <td colspan="7" class="p-1.5 font-medium text-gray-500 border-b border-gray-200">Ohne Gruppe</td>
                                            </tr>
                                            <tr v-for="element in getElementeForGruppe('')" :key="'tbl-ng-' + element.id"
                                                class="hover:bg-blue-50 border-b border-gray-100"
                                                draggable="true"
                                                @dragstart="onDragStart($event, element)"
                                                @dragover="onDragOver($event, element)"
                                                @dragleave="onDragLeave($event)"
                                                @drop="onDrop($event, element)"
                                                @dragend="onDragEnd($event)">
                                                <td class="p-1 text-center"><span class="drag-handle text-gray-400 cursor-grab">⋮⋮</span></td>
                                                <td class="p-1"><input v-model="element.name" @input="saveToStorage" type="text" class="w-full border border-transparent hover:border-gray-300 focus:border-blue-400 rounded px-1 py-0.5 bg-transparent"></td>
                                                <td class="p-1"><span :class="element.typ === 'phase' ? 'text-red-600' : 'text-amber-600'">{{ element.typ === 'phase' ? 'Phase' : 'MS' }}</span></td>
                                                <td class="p-1">
                                                    <input v-if="element.typ === 'phase'" v-model="element.start" @input="saveToStorage" type="date" class="w-full border border-transparent hover:border-gray-300 focus:border-blue-400 rounded px-1 py-0.5 bg-transparent text-xs">
                                                    <input v-else v-model="element.datum" @input="saveToStorage" type="date" class="w-full border border-transparent hover:border-gray-300 focus:border-blue-400 rounded px-1 py-0.5 bg-transparent text-xs">
                                                </td>
                                                <td class="p-1">
                                                    <input v-if="element.typ === 'phase'" v-model="element.ende" @input="saveToStorage" type="date" class="w-full border border-transparent hover:border-gray-300 focus:border-blue-400 rounded px-1 py-0.5 bg-transparent text-xs">
                                                    <span v-else class="text-gray-300">-</span>
                                                </td>
                                                <td class="p-1">
                                                    <div v-if="element.typ === 'phase'" class="flex space-x-1">
                                                        <button @click="element.farbe = 'gruen'; saveToStorage()" :class="['w-4 h-4 rounded', element.farbe === 'gruen' ? 'ring-2 ring-gray-800' : '']" style="background-color: #166534;"></button>
                                                        <button @click="element.farbe = 'rot'; saveToStorage()" :class="['w-4 h-4 rounded', element.farbe === 'rot' ? 'ring-2 ring-gray-800' : '']" style="background-color: #991B1B;"></button>
                                                        <button @click="element.farbe = 'dunkelrot'; saveToStorage()" :class="['w-4 h-4 rounded', element.farbe === 'dunkelrot' ? 'ring-2 ring-gray-800' : '']" style="background-color: #450a0a;"></button>
                                                    </div>
                                                    <span v-else class="text-gray-300">-</span>
                                                </td>
                                                <td class="p-1">
                                                    <div class="flex space-x-1">
                                                        <button @click="duplicateElement(element)" class="text-blue-400 hover:text-blue-600">D</button>
                                                        <button @click="deleteElement(element.id)" class="text-red-400 hover:text-red-600">X</button>
                                                    </div>
                                                </td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>

                            <div v-if="currentProject.elemente.length === 0" class="text-gray-400 text-sm p-4 text-center border border-dashed border-gray-300 rounded">
                                Keine Phasen oder Meilensteine vorhanden.<br>
                                Erstellen Sie zuerst Gruppen, dann fügen Sie Elemente hinzu.
                            </div>
                        </div>
                    </div>

                    <!-- Resize Handle -->
                    <div class="resize-handle relative no-print"
                         :class="{ 'resizing': isResizing }"
                         @mousedown="startResize"></div>

                    <!-- Timeline Canvas -->
                    <div class="flex-1 overflow-auto bg-gray-200 p-6">
                        <div ref="timelineContainer" class="shadow-lg"
                             :class="darkMode ? 'bg-gray-900' : 'bg-white'"
                             :style="{ minWidth: (verticalMode ? verticalCanvasWidth : canvasWidth) + 'px' }">
                            <!-- Legende -->
                            <div v-if="currentProject.einstellungen.legendeAnzeigen"
                                 class="px-6 pt-4 pb-2 border-b flex items-center flex-wrap gap-x-6 gap-y-2 text-xs"
                                 :class="darkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'">
                                <!-- Dynamische Farb-Kategorien -->
                                <template v-for="color in usedColors" :key="color.key">
                                    <div class="flex items-center space-x-2">
                                        <div class="w-8 h-3 rounded-sm" :style="{ backgroundColor: color.hex }"></div>
                                        <span :class="darkMode ? 'text-gray-300' : 'text-gray-600'">{{ color.name }}</span>
                                    </div>
                                </template>
                                <div v-if="hasBuffer" class="flex items-center space-x-2">
                                    <svg width="32" height="12"><line x1="0" y1="6" x2="32" y2="6" :stroke="themeColors.milestone" stroke-width="3" stroke-dasharray="8,4"/></svg>
                                    <span :class="darkMode ? 'text-gray-300' : 'text-gray-600'">Zeitreserve</span>
                                </div>
                                <div v-if="hasMilestones" class="flex items-center space-x-2">
                                    <svg width="16" height="16" viewBox="0 0 16 16"><polygon points="8,2 14,8 8,14 2,8" fill="none" :stroke="themeColors.milestone" stroke-width="1.5"/></svg>
                                    <span :class="darkMode ? 'text-gray-300' : 'text-gray-600'">Meilenstein</span>
                                </div>
                                <div v-if="hasCritical" class="flex items-center space-x-2">
                                    <div class="w-0.5 h-4" :class="darkMode ? 'bg-gray-300' : 'bg-gray-800'"></div>
                                    <span :class="darkMode ? 'text-gray-300' : 'text-gray-600'">Kritischer Pfad</span>
                                </div>
                            </div>

                            <!-- Horizontale Timeline -->
                            <svg v-if="!verticalMode" ref="timelineSvg" :width="canvasWidth" :height="canvasHeight" class="timeline-svg">
                                <!-- Hintergrund -->
                                <rect x="0" y="0" :width="canvasWidth" :height="canvasHeight" :fill="themeColors.background"/>

                                <!-- Zeitachse Header - Jahr -->
                                <g class="time-axis-year">
                                    <rect :x="labelWidth" y="0" :width="canvasWidth - labelWidth" height="24" :fill="themeColors.headerBg"/>
                                    <template v-for="(year, index) in yearPeriods" :key="'y-' + index">
                                        <text v-if="year.showLabel" :x="year.labelX" y="16" text-anchor="middle" font-size="13" font-weight="600" :fill="themeColors.textPrimary">
                                            {{ year.label }}
                                        </text>
                                        <line v-if="index > 0" :x1="year.x" y1="0" :x2="year.x" y2="24" :stroke="themeColors.border" stroke-width="1"/>
                                    </template>
                                </g>

                                <!-- Zeitachse Header - Monate -->
                                <g class="time-axis-months">
                                    <rect :x="labelWidth" y="24" :width="canvasWidth - labelWidth" height="24" :fill="themeColors.background"/>
                                    <line :x1="labelWidth" y1="24" :x2="canvasWidth" y2="24" :stroke="themeColors.border" stroke-width="1"/>
                                    <template v-for="(period, index) in timePeriods" :key="'m-' + index">
                                        <text :x="period.x + period.width/2" y="40" text-anchor="middle" font-size="11" :fill="themeColors.textSecondary">
                                            {{ period.label }}
                                        </text>
                                        <line :x1="period.x" y1="24" :x2="period.x" :y2="canvasHeight" :stroke="themeColors.gridLine" stroke-width="0.5"/>
                                    </template>
                                </g>

                                <!-- Thema Label -->
                                <g class="theme-label">
                                    <rect x="0" y="0" :width="labelWidth" height="48" :fill="themeColors.headerBg"/>
                                    <text x="12" y="32" font-size="13" font-weight="600" :fill="themeColors.textPrimary">Thema</text>
                                    <line x1="0" y1="48" :x2="canvasWidth" y2="48" :stroke="themeColors.border" stroke-width="1"/>
                                    <line :x1="labelWidth" y1="0" :x2="labelWidth" :y2="canvasHeight" :stroke="themeColors.border" stroke-width="1"/>
                                </g>

                                <!-- Heute-Markierung oben -->
                                <g v-if="currentProject.einstellungen.heuteAnzeigen && todayX >= labelWidth" class="today-marker">
                                    <rect :x="todayX - 25" y="2" width="50" height="18" :fill="themeColors.todayBg" rx="2"/>
                                    <text :x="todayX" y="14" text-anchor="middle" font-size="10" fill="white" font-weight="500">Heute</text>
                                </g>

                                <!-- Content Rows -->
                                <g class="content-rows" transform="translate(0, 48)">
                                    <template v-for="(row, rowIndex) in displayRows" :key="'row-' + rowIndex">
                                        <!-- Row Background -->
                                        <rect x="0" :y="rowIndex * rowHeight" :width="canvasWidth" :height="rowHeight"
                                              :fill="rowIndex % 2 === 0 ? themeColors.rowEven : themeColors.rowOdd" class="row-hover"/>
                                        <line x1="0" :y1="(rowIndex + 1) * rowHeight" :x2="canvasWidth" :y2="(rowIndex + 1) * rowHeight" :stroke="themeColors.gridLine" stroke-width="0.5"/>

                                        <!-- Label -->
                                        <text v-if="row.type === 'gruppe'"
                                              x="12" :y="rowIndex * rowHeight + rowHeight/2 + 4"
                                              font-size="12" font-weight="700" :fill="row.color || themeColors.milestone">
                                            {{ row.name }}
                                        </text>
                                        <text v-else
                                              :x="24 + (row.einrueckung || 0) * 16" :y="rowIndex * rowHeight + rowHeight/2 + 4"
                                              font-size="11" :fill="themeColors.textPrimary">
                                            {{ row.name }}
                                        </text>

                                        <!-- Phase Bar -->
                                        <g v-if="row.type === 'phase' && row.startX !== null">
                                            <!-- Hauptbalken -->
                                            <rect :x="row.startX"
                                                  :y="rowIndex * rowHeight + 8"
                                                  :width="Math.max(row.width, 8)"
                                                  :height="rowHeight - 16"
                                                  :fill="row.color"
                                                  class="phase-bar"
                                                  rx="2"/>

                                            <!-- Kritischer Pfad Markierung (Linie am Ende) -->
                                            <line v-if="row.kritisch"
                                                  :x1="row.startX + row.width"
                                                  :y1="rowIndex * rowHeight + 4"
                                                  :x2="row.startX + row.width"
                                                  :y2="rowIndex * rowHeight + rowHeight - 4"
                                                  :stroke="themeColors.milestone"
                                                  stroke-width="2"/>

                                            <!-- Puffer (gestrichelte Linie) -->
                                            <line v-if="row.pufferWidth > 0"
                                                  :x1="row.startX + row.width"
                                                  :y1="rowIndex * rowHeight + rowHeight/2"
                                                  :x2="row.startX + row.width + row.pufferWidth"
                                                  :y2="rowIndex * rowHeight + rowHeight/2"
                                                  :stroke="row.color"
                                                  class="buffer-line"/>
                                        </g>

                                        <!-- Meilenstein -->
                                        <g v-if="row.type === 'meilenstein' && row.x !== null">
                                            <polygon :points="getMilestonePoints(row.x, rowIndex * rowHeight + rowHeight/2)"
                                                     fill="none" :stroke="themeColors.milestone" stroke-width="1.5"
                                                     class="milestone-icon"/>
                                        </g>
                                    </template>

                                    <!-- Heute-Linie vertikal -->
                                    <line v-if="currentProject.einstellungen.heuteAnzeigen && todayX >= labelWidth"
                                          :x1="todayX" y1="0" :x2="todayX" :y2="displayRows.length * rowHeight"
                                          :stroke="darkMode ? '#F3F4F6' : '#1F2937'"
                                          stroke-width="2"/>
                                </g>
                            </svg>

                            <!-- Vertikale Roadmap -->
                            <svg v-else ref="timelineSvg" :width="verticalCanvasWidth" :height="verticalCanvasHeight" class="timeline-svg">
                                <!-- Hintergrund -->
                                <rect x="0" y="0" :width="verticalCanvasWidth" :height="verticalCanvasHeight" :fill="themeColors.background"/>

                                <!-- Header -->
                                <rect x="0" y="0" :width="verticalCanvasWidth" height="40" :fill="themeColors.headerBg"/>
                                <text :x="verticalCanvasWidth / 2" y="26" text-anchor="middle" font-size="14" font-weight="600" :fill="themeColors.textPrimary">
                                    {{ currentProject.projekt.name }}
                                </text>
                                <line x1="0" y1="40" :x2="verticalCanvasWidth" y2="40" :stroke="themeColors.border" stroke-width="1"/>

                                <!-- Mittige Zeitlinie -->
                                <line :x1="verticalCanvasWidth / 2" y1="50" :x2="verticalCanvasWidth / 2" :y2="verticalCanvasHeight - 20"
                                      :stroke="themeColors.border" stroke-width="2"/>

                                <!-- Zeitperioden-Marker (Monate) -->
                                <template v-for="(period, index) in verticalTimePeriods" :key="'vp-' + index">
                                    <!-- Horizontale Linie -->
                                    <line x1="100" :y1="period.y" :x2="verticalCanvasWidth - 100" :y2="period.y"
                                          :stroke="themeColors.gridLine" stroke-width="0.5" stroke-dasharray="4,4"/>
                                    <!-- Monatslabel links -->
                                    <text x="90" :y="period.y + 4" text-anchor="end" font-size="10" :fill="themeColors.textSecondary">
                                        {{ period.label }}
                                    </text>
                                </template>

                                <!-- Elemente -->
                                <template v-for="(elem, index) in verticalElements" :key="'ve-' + index">
                                    <!-- Gruppen-Header -->
                                    <g v-if="elem.type === 'gruppe'">
                                        <text :x="verticalCanvasWidth / 2" :y="verticalHeaderHeight - 10" text-anchor="middle"
                                              font-size="11" font-weight="700" :fill="themeColors.milestone">
                                            {{ elem.name }}
                                        </text>
                                    </g>

                                    <!-- Phase (links oder rechts) -->
                                    <g v-if="elem.type === 'phase'">
                                        <!-- Verbindungslinie zur Zeitlinie -->
                                        <line :x1="elem.side === 'left' ? verticalCanvasWidth/2 - 80 : verticalCanvasWidth/2 + 80"
                                              :y1="elem.startY + elem.height/2"
                                              :x2="verticalCanvasWidth / 2"
                                              :y2="elem.startY + elem.height/2"
                                              :stroke="elem.color" stroke-width="1"/>
                                        <!-- Punkt auf der Zeitlinie -->
                                        <circle :cx="verticalCanvasWidth / 2" :cy="elem.startY + elem.height/2" r="4" :fill="elem.color"/>
                                        <!-- Phasen-Block -->
                                        <rect :x="elem.side === 'left' ? verticalCanvasWidth/2 - 200 : verticalCanvasWidth/2 + 80"
                                              :y="elem.startY"
                                              width="120"
                                              :height="Math.max(elem.height, 24)"
                                              :fill="elem.color"
                                              rx="4"
                                              class="phase-bar"/>
                                        <!-- Phasen-Name -->
                                        <text :x="elem.side === 'left' ? verticalCanvasWidth/2 - 140 : verticalCanvasWidth/2 + 140"
                                              :y="elem.startY + Math.max(elem.height, 24)/2 + 4"
                                              text-anchor="middle"
                                              font-size="10" fill="white" font-weight="500">
                                            {{ elem.name.length > 14 ? elem.name.substring(0, 14) + '...' : elem.name }}
                                        </text>
                                        <!-- Kritischer Pfad Markierung -->
                                        <line v-if="elem.kritisch"
                                              :x1="elem.side === 'left' ? verticalCanvasWidth/2 - 200 : verticalCanvasWidth/2 + 80"
                                              :y1="elem.startY + elem.height"
                                              :x2="elem.side === 'left' ? verticalCanvasWidth/2 - 80 : verticalCanvasWidth/2 + 200"
                                              :y2="elem.startY + elem.height"
                                              :stroke="themeColors.milestone"
                                              stroke-width="2"/>
                                    </g>

                                    <!-- Meilenstein -->
                                    <g v-if="elem.type === 'meilenstein'">
                                        <!-- Raute auf Zeitlinie -->
                                        <polygon :points="getMilestonePoints(verticalCanvasWidth/2, elem.y)"
                                                 fill="none" :stroke="themeColors.milestone" stroke-width="2"/>
                                        <!-- Label -->
                                        <text :x="elem.side === 'left' ? verticalCanvasWidth/2 - 20 : verticalCanvasWidth/2 + 20"
                                              :y="elem.y + 4"
                                              :text-anchor="elem.side === 'left' ? 'end' : 'start'"
                                              font-size="10" font-weight="500" :fill="themeColors.textPrimary">
                                            {{ elem.name }}
                                        </text>
                                    </g>
                                </template>

                                <!-- Heute-Linie horizontal -->
                                <g v-if="currentProject.einstellungen.heuteAnzeigen && todayY >= verticalHeaderHeight">
                                    <line x1="50" :y1="todayY" :x2="verticalCanvasWidth - 50" :y2="todayY"
                                          :stroke="themeColors.todayBg" stroke-width="2"/>
                                    <rect :x="verticalCanvasWidth - 70" :y="todayY - 10" width="50" height="18" :fill="themeColors.todayBg" rx="2"/>
                                    <text :x="verticalCanvasWidth - 45" :y="todayY + 3" text-anchor="middle" font-size="9" fill="white" font-weight="500">Heute</text>
                                </g>
                            </svg>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Export Modal -->
        <div v-if="showExportModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-xl p-6 w-96">
                <h3 class="text-lg font-semibold mb-4">Timeline exportieren</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">Format</label>
                        <div class="flex space-x-4">
                            <label class="flex items-center space-x-2">
                                <input type="radio" v-model="exportSettings.format" value="png">
                                <span>PNG</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="radio" v-model="exportSettings.format" value="svg">
                                <span>SVG</span>
                            </label>
                        </div>
                    </div>
                    <div v-if="exportSettings.format === 'png'">
                        <label class="block text-sm text-gray-600 mb-1">Skalierung</label>
                        <select v-model.number="exportSettings.scale" class="w-full border border-gray-300 rounded px-3 py-2">
                            <option :value="1">1x (Standard)</option>
                            <option :value="2">2x (Hohe Auflösung)</option>
                            <option :value="3">3x (Sehr hohe Auflösung)</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button @click="showExportModal = false" class="px-4 py-2 border border-gray-300 rounded hover:bg-gray-50">Abbrechen</button>
                    <button @click="exportTimeline" class="px-4 py-2 bg-red-700 text-white rounded hover:bg-red-800">Exportieren</button>
                </div>
            </div>
        </div>

        <!-- JSON/CSV Import/Export Modal -->
        <div v-if="showImportExportModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-xl p-6 w-[600px] max-h-[90vh] overflow-y-auto">
                <h3 class="text-lg font-semibold mb-4">Import/Export</h3>

                <!-- CSV Import Section -->
                <div class="mb-6 p-4 bg-green-50 border border-green-200 rounded">
                    <h4 class="font-medium text-green-800 mb-2">CSV Import (aus Excel)</h4>
                    <p class="text-xs text-green-700 mb-3">
                        Importiere Projektdaten aus einer CSV-Datei. Erstelle die Datei in Excel und speichere sie als CSV (Semikolon-getrennt).
                    </p>
                    <div class="flex items-center space-x-2">
                        <label class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 cursor-pointer text-sm">
                            CSV-Datei auswählen
                            <input type="file" accept=".csv" @change="handleCsvFileSelect" class="hidden">
                        </label>
                        <button @click="downloadCsvTemplate" class="px-4 py-2 border border-green-600 text-green-600 rounded hover:bg-green-50 text-sm">
                            Vorlage herunterladen
                        </button>
                    </div>
                </div>

                <!-- JSON Section -->
                <div class="space-y-4">
                    <h4 class="font-medium text-gray-700">JSON Import/Export</h4>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">Projekt-JSON</label>
                        <textarea v-model="jsonDataInput" rows="12" class="w-full border border-gray-300 rounded px-3 py-2 font-mono text-xs"></textarea>
                    </div>
                </div>
                <div class="flex justify-between mt-6">
                    <div class="space-x-2">
                        <button @click="copyJsonToClipboard" class="px-4 py-2 border border-gray-300 rounded hover:bg-gray-50">Kopieren</button>
                        <button @click="importFromJson" class="px-4 py-2 border border-blue-500 text-blue-600 rounded hover:bg-blue-50">JSON Importieren</button>
                    </div>
                    <button @click="showImportExportModal = false" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Schließen</button>
                </div>
            </div>
        </div>

        <!-- Vorlagen Modal -->
        <div v-if="showTemplatesModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-xl p-6 w-[500px] max-h-[80vh] flex flex-col">
                <h3 class="text-lg font-semibold mb-4">Vorlagen verwalten</h3>
                <div class="flex-1 overflow-y-auto">
                    <div v-if="templates.length === 0" class="text-gray-400 text-center py-8">
                        Keine Vorlagen gespeichert.<br>
                        <span class="text-sm">Speichere ein Projekt als Vorlage über "Als Vorlage speichern".</span>
                    </div>
                    <div v-else class="space-y-2">
                        <div v-for="template in templates" :key="template.id"
                             class="border border-gray-200 rounded p-3 bg-gray-50">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="font-medium text-gray-800">{{ template.name }}</div>
                                    <div class="text-xs text-gray-500">
                                        {{ template.gruppen?.length || 0 }} Gruppen,
                                        {{ template.elemente?.length || 0 }} Elemente
                                    </div>
                                    <div class="text-xs text-gray-400">Erstellt: {{ formatDateShort(template.erstelltAm) }}</div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button @click="createFromTemplate(template); showTemplatesModal = false"
                                            class="px-3 py-1 text-sm bg-green-500 text-white rounded hover:bg-green-600">
                                        Verwenden
                                    </button>
                                    <button @click="exportTemplateAsJson(template)"
                                            class="px-2 py-1 text-sm border border-gray-300 rounded hover:bg-gray-100">
                                        JSON
                                    </button>
                                    <button @click="deleteTemplate(template.id)"
                                            class="px-2 py-1 text-sm text-red-500 hover:text-red-700 hover:bg-red-50 rounded">
                                        Löschen
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex justify-between mt-6 pt-4 border-t border-gray-200">
                    <button @click="importTemplateFromJson" class="px-4 py-2 border border-blue-500 text-blue-600 rounded hover:bg-blue-50">
                        Vorlage importieren
                    </button>
                    <button @click="showTemplatesModal = false" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Schließen</button>
                </div>
            </div>
        </div>

        <!-- Vorlage speichern Modal -->
        <div v-if="showSaveTemplateModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-xl p-6 w-96">
                <h3 class="text-lg font-semibold mb-4">Als Vorlage speichern</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">Vorlagenname</label>
                        <input v-model="newTemplateName" type="text" class="w-full border border-gray-300 rounded px-3 py-2"
                               placeholder="z.B. Standard Transition" @keyup.enter="confirmSaveTemplate">
                    </div>
                    <p class="text-xs text-gray-500">
                        Die Vorlage enthält alle Gruppen und Elemente des aktuellen Projekts.
                        Beim Erstellen eines neuen Projekts werden die Daten relativ zum neuen Startdatum angepasst.
                    </p>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button @click="showSaveTemplateModal = false" class="px-4 py-2 border border-gray-300 rounded hover:bg-gray-50">Abbrechen</button>
                    <button @click="confirmSaveTemplate" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Speichern</button>
                </div>
            </div>
        </div>

        <!-- Batch-Eingabe Modal -->
        <div v-if="showBatchInputModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-xl p-6 w-[600px]">
                <h3 class="text-lg font-semibold mb-4">Mehrere Elemente hinzufügen</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">Ziel-Gruppe</label>
                        <select v-model="batchInputGruppe" class="w-full border border-gray-300 rounded px-3 py-2 text-sm bg-white">
                            <option value="">-- Keine Gruppe --</option>
                            <option v-for="g in sortedGruppen" :key="g.id" :value="g.id">{{ g.name }}</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">Elemente (eine Zeile pro Element)</label>
                        <textarea v-model="batchInputText" rows="10" class="w-full border border-gray-300 rounded px-3 py-2 font-mono text-xs"
                                  placeholder="phase;Analyse;2025-01-01;2025-01-31;gruen
phase;Konzeption;2025-02-01;2025-02-28;rot;14;ja
meilenstein;Kickoff;2025-01-15"></textarea>
                    </div>
                    <div class="text-xs text-gray-500 bg-gray-50 p-3 rounded">
                        <strong>Format:</strong><br>
                        Phase: <code>phase;Name;Start;Ende;Farbe;Puffer;Kritisch</code><br>
                        Meilenstein: <code>meilenstein;Name;Datum</code><br><br>
                        <strong>Farben:</strong> gruen, rot, dunkelrot<br>
                        <strong>Datum:</strong> YYYY-MM-DD oder DD.MM.YYYY<br>
                        <strong>Kritisch:</strong> ja oder leer lassen
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button @click="showBatchInputModal = false" class="px-4 py-2 border border-gray-300 rounded hover:bg-gray-50">Abbrechen</button>
                    <button @click="processBatchInput" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Hinzufügen</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    const { createApp, ref, computed, watch, onMounted, nextTick } = Vue;

    createApp({
        setup() {
            // State
            const projects = ref([]);
            const templates = ref([]);
            const currentProjectId = ref(null);
            const activeTab = ref('projekt');

            // Elemente-Ansicht State
            const elementeView = ref('kompakt'); // 'kompakt' oder 'tabelle'
            const expandedElementId = ref(null);
            const collapsedGroups = ref(new Set());

            // Panel Resize State
            const editorPanelWidth = ref(380);
            const isResizing = ref(false);
            const minPanelWidth = 280;
            const maxPanelWidth = 600;

            // Drag & Drop State
            const draggedElement = ref(null);
            const dragOverId = ref(null);
            const showExportModal = ref(false);
            const showImportExportModal = ref(false);
            const showTemplatesModal = ref(false);
            const showSaveTemplateModal = ref(false);
            const newTemplateName = ref('');
            const jsonDataInput = ref('');
            const timelineContainer = ref(null);
            const timelineSvg = ref(null);

            // Batch-Eingabe State
            const showBatchInputModal = ref(false);
            const batchInputText = ref('');
            const batchInputGruppe = ref('');

            // Präsentations-Ansichten
            const darkMode = ref(false);
            const showExecutiveSummary = ref(false);
            const verticalMode = ref(false);

            const rowHeight = 28;
            const labelWidth = 280;

            const exportSettings = ref({
                format: 'png',
                scale: 2
            });

            // Farben
            const colors = {
                gruen: '#166534',
                rot: '#991B1B',
                dunkelrot: '#450a0a'
            };

            // Theme-Farben (Hell/Dunkel)
            const themeColors = computed(() => ({
                background: darkMode.value ? '#1F2937' : '#F9FAFB',
                headerBg: darkMode.value ? '#374151' : '#F3F4F6',
                rowEven: darkMode.value ? '#111827' : '#FFFFFF',
                rowOdd: darkMode.value ? '#1F2937' : '#FAFAFA',
                textPrimary: darkMode.value ? '#F3F4F6' : '#374151',
                textSecondary: darkMode.value ? '#9CA3AF' : '#6B7280',
                gridLine: darkMode.value ? '#4B5563' : '#E5E7EB',
                border: darkMode.value ? '#6B7280' : '#D1D5DB',
                milestone: darkMode.value ? '#F87171' : '#991B1B',
                todayBg: darkMode.value ? '#DC2626' : '#991B1B'
            }));

            // Computed
            const currentProject = computed(() => {
                return projects.value.find(p => p.id === currentProjectId.value) || null;
            });

            const sortedGruppen = computed(() => {
                if (!currentProject.value) return [];
                return [...currentProject.value.gruppen].sort((a, b) => a.reihenfolge - b.reihenfolge);
            });

            const sortedElemente = computed(() => {
                if (!currentProject.value) return [];
                return [...currentProject.value.elemente].sort((a, b) => a.reihenfolge - b.reihenfolge);
            });

            // Legende: Verwendete Farben ermitteln
            const usedColors = computed(() => {
                if (!currentProject.value) return [];
                const used = new Set();
                currentProject.value.elemente.forEach(e => {
                    if (e.typ === 'phase' && e.farbe) {
                        used.add(e.farbe);
                    }
                });
                const farbNamen = currentProject.value.einstellungen?.farbNamen || {};
                const defaultNames = { gruen: 'Vorbereitung', rot: 'Plandauer', dunkelrot: 'Kritisch' };
                return Array.from(used).map(key => ({
                    key,
                    hex: colors[key] || '#991B1B',
                    name: farbNamen[key] || defaultNames[key] || key
                }));
            });

            const hasBuffer = computed(() => {
                if (!currentProject.value) return false;
                return currentProject.value.elemente.some(e => e.typ === 'phase' && e.pufferTage > 0);
            });

            const hasMilestones = computed(() => {
                if (!currentProject.value) return false;
                return currentProject.value.elemente.some(e => e.typ === 'meilenstein');
            });

            const hasCritical = computed(() => {
                if (!currentProject.value) return false;
                return currentProject.value.elemente.some(e => e.typ === 'phase' && e.kritisch);
            });

            const projectDuration = computed(() => {
                if (!currentProject.value) return { start: null, end: null, days: 0 };
                const start = new Date(currentProject.value.projekt.start);
                const end = new Date(currentProject.value.projekt.ende);
                const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
                return { start, end, days };
            });

            const pixelsPerDay = computed(() => {
                if (!currentProject.value) return 3;
                return currentProject.value.einstellungen.zeitskala === 'quartal' ? 1.5 : 3;
            });

            const canvasWidth = computed(() => {
                const minWidth = 900;
                const daysToShow = projectDuration.value.days || 365;
                return Math.max(minWidth, labelWidth + daysToShow * pixelsPerDay.value + 50);
            });

            const timelineRows = computed(() => {
                if (!currentProject.value) return [];
                const rows = [];

                // Für jede Gruppe und ihre Elemente
                for (const gruppe of sortedGruppen.value) {
                    // Gruppe als Header-Zeile
                    rows.push({
                        type: 'gruppe',
                        name: gruppe.name,
                        color: '#991B1B'
                    });

                    // Maximale X-Position (Canvas-Ende)
                    const maxX = canvasWidth.value - 10;

                    // Elemente dieser Gruppe
                    const gruppenElemente = sortedElemente.value.filter(e => e.gruppe === gruppe.id);
                    for (const element of gruppenElemente) {
                        if (element.typ === 'phase') {
                            const startX = getDateX(element.start);
                            const endX = getDateX(element.ende);
                            const rawWidth = Math.max(endX - startX, 8);
                            // Clip width to not exceed canvas
                            const clippedWidth = Math.min(rawWidth, maxX - startX);
                            const puffer = (element.pufferTage || 0) * pixelsPerDay.value;
                            // Clip buffer to not exceed canvas
                            const clippedPuffer = Math.max(0, Math.min(puffer, maxX - startX - clippedWidth));
                            rows.push({
                                type: 'phase',
                                name: element.name,
                                einrueckung: element.einrueckung || 0,
                                startX: startX,
                                width: clippedWidth,
                                pufferWidth: clippedPuffer,
                                color: colors[element.farbe] || colors.rot,
                                kritisch: element.kritisch
                            });
                        } else {
                            rows.push({
                                type: 'meilenstein',
                                name: element.name,
                                einrueckung: element.einrueckung || 0,
                                x: getDateX(element.datum)
                            });
                        }
                    }
                }

                // Elemente ohne Gruppe
                const ohneGruppe = sortedElemente.value.filter(e => !e.gruppe);
                if (ohneGruppe.length > 0) {
                    const maxX = canvasWidth.value - 10;
                    for (const element of ohneGruppe) {
                        if (element.typ === 'phase') {
                            const startX = getDateX(element.start);
                            const endX = getDateX(element.ende);
                            const rawWidth = Math.max(endX - startX, 8);
                            const clippedWidth = Math.min(rawWidth, maxX - startX);
                            const puffer = (element.pufferTage || 0) * pixelsPerDay.value;
                            const clippedPuffer = Math.max(0, Math.min(puffer, maxX - startX - clippedWidth));
                            rows.push({
                                type: 'phase',
                                name: element.name,
                                einrueckung: element.einrueckung || 0,
                                startX: startX,
                                width: clippedWidth,
                                pufferWidth: clippedPuffer,
                                color: colors[element.farbe] || colors.rot,
                                kritisch: element.kritisch
                            });
                        } else {
                            rows.push({
                                type: 'meilenstein',
                                name: element.name,
                                einrueckung: element.einrueckung || 0,
                                x: getDateX(element.datum)
                            });
                        }
                    }
                }

                return rows;
            });

            // Executive Summary Filter
            const displayRows = computed(() => {
                if (!showExecutiveSummary.value) return timelineRows.value;
                return timelineRows.value.filter(row => {
                    if (row.type === 'gruppe') return true;
                    if (row.type === 'meilenstein') return true;
                    if (row.type === 'phase' && (row.einrueckung || 0) === 0) return true;
                    return false;
                });
            });

            const canvasHeight = computed(() => {
                const legendeHeight = currentProject.value?.einstellungen.legendeAnzeigen ? 0 : 0;
                return 48 + displayRows.value.length * rowHeight + 20;
            });

            const yearPeriods = computed(() => {
                if (!currentProject.value || !projectDuration.value.start) return [];
                const periods = [];
                const { start, end } = projectDuration.value;

                let currentYear = start.getFullYear();
                const endYear = end.getFullYear();

                while (currentYear <= endYear) {
                    const yearStart = new Date(currentYear, 0, 1);
                    const yearEnd = new Date(currentYear, 11, 31);

                    const displayStart = yearStart < start ? start : yearStart;
                    const displayEnd = yearEnd > end ? end : yearEnd;

                    const x = getDateX(displayStart);
                    const endX = getDateX(displayEnd);
                    const width = endX - x;

                    // Only show label if there's enough width (> 60px)
                    const showLabel = width > 60;
                    // Center the label, but ensure it's at least at labelWidth + 30
                    const labelX = Math.max(labelWidth + 30, x + width / 2);

                    periods.push({
                        label: currentYear.toString(),
                        x: x,
                        width: width,
                        labelX: labelX,
                        showLabel: showLabel
                    });

                    currentYear++;
                }
                return periods;
            });

            const timePeriods = computed(() => {
                if (!currentProject.value || !projectDuration.value.start) return [];
                const periods = [];
                const { start, end } = projectDuration.value;
                const scale = currentProject.value.einstellungen.zeitskala;

                const monthNames = ['JAN', 'FEB', 'MÄR', 'APR', 'MAI', 'JUN', 'JUL', 'AUG', 'SEP', 'OKT', 'NOV', 'DEZ'];

                let current = new Date(start.getFullYear(), start.getMonth(), 1);

                while (current <= end) {
                    let label, nextDate;

                    if (scale === 'quartal') {
                        const quarter = Math.floor(current.getMonth() / 3) + 1;
                        label = `Q${quarter}`;
                        nextDate = new Date(current);
                        nextDate.setMonth(nextDate.getMonth() + 3);
                    } else {
                        label = monthNames[current.getMonth()];
                        nextDate = new Date(current);
                        nextDate.setMonth(nextDate.getMonth() + 1);
                    }

                    const x = getDateX(current);
                    const width = getDateX(nextDate) - x;

                    if (x >= labelWidth - 10) {
                        periods.push({ label, x, width });
                    }
                    current = nextDate;
                }
                return periods;
            });

            const todayX = computed(() => {
                if (!currentProject.value) return -1;
                return getDateX(new Date());
            });

            // Vertikale Roadmap - Dimensionen
            const verticalCanvasWidth = 700;
            const verticalHeaderHeight = 60;
            const verticalCanvasHeight = computed(() => {
                if (!verticalMode.value || !projectDuration.value.days) return 600;
                return verticalHeaderHeight + projectDuration.value.days * pixelsPerDay.value + 100;
            });

            // Vertikale Zeitperioden (Monate als horizontale Marker)
            const verticalTimePeriods = computed(() => {
                if (!currentProject.value || !projectDuration.value.start) return [];
                const periods = [];
                const { start, end } = projectDuration.value;
                const scale = currentProject.value.einstellungen.zeitskala;
                const monthNames = ['JAN', 'FEB', 'MÄR', 'APR', 'MAI', 'JUN', 'JUL', 'AUG', 'SEP', 'OKT', 'NOV', 'DEZ'];
                let current = new Date(start.getFullYear(), start.getMonth(), 1);

                while (current <= end) {
                    let label, nextDate;
                    if (scale === 'quartal') {
                        const quarter = Math.floor(current.getMonth() / 3) + 1;
                        label = `Q${quarter} ${current.getFullYear()}`;
                        nextDate = new Date(current);
                        nextDate.setMonth(nextDate.getMonth() + 3);
                    } else {
                        label = `${monthNames[current.getMonth()]} ${current.getFullYear()}`;
                        nextDate = new Date(current);
                        nextDate.setMonth(nextDate.getMonth() + 1);
                    }
                    const y = getDateY(current);
                    const height = getDateY(nextDate) - y;
                    periods.push({ label, y, height });
                    current = nextDate;
                }
                return periods;
            });

            // Vertikale Timeline-Elemente (mit Seiten-Zuweisung)
            const verticalElements = computed(() => {
                if (!currentProject.value) return [];
                const elements = [];
                let leftSide = true; // Alterniert zwischen links und rechts

                for (const gruppe of sortedGruppen.value) {
                    // Gruppe-Header
                    elements.push({
                        type: 'gruppe',
                        name: gruppe.name,
                        side: 'center'
                    });

                    const gruppenElemente = sortedElemente.value.filter(e => e.gruppe === gruppe.id);
                    for (const element of gruppenElemente) {
                        if (showExecutiveSummary.value) {
                            if (element.typ === 'phase' && (element.einrueckung || 0) > 0) continue;
                        }

                        if (element.typ === 'phase') {
                            const startY = getDateY(element.start);
                            const endY = getDateY(element.ende);
                            elements.push({
                                type: 'phase',
                                name: element.name,
                                startY: startY,
                                height: Math.max(endY - startY, 20),
                                color: colors[element.farbe] || colors.rot,
                                kritisch: element.kritisch,
                                pufferHeight: (element.pufferTage || 0) * pixelsPerDay.value,
                                side: leftSide ? 'left' : 'right'
                            });
                            leftSide = !leftSide;
                        } else {
                            elements.push({
                                type: 'meilenstein',
                                name: element.name,
                                y: getDateY(element.datum),
                                side: leftSide ? 'left' : 'right'
                            });
                            leftSide = !leftSide;
                        }
                    }
                }
                return elements;
            });

            const todayY = computed(() => {
                if (!currentProject.value || !verticalMode.value) return -1;
                return getDateY(new Date());
            });

            // Watch for modal open to update JSON
            watch(showImportExportModal, (newVal) => {
                if (newVal && currentProject.value) {
                    jsonDataInput.value = JSON.stringify(currentProject.value, null, 2);
                }
            });

            // Methods
            function generateId() {
                return 'id_' + Math.random().toString(36).substr(2, 9);
            }

            function formatDateShort(dateStr) {
                if (!dateStr) return '';
                const date = new Date(dateStr);
                return date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: '2-digit' });
            }

            function getDateX(date) {
                if (!projectDuration.value.start) return labelWidth;
                const d = typeof date === 'string' ? new Date(date) : date;
                const daysDiff = (d - projectDuration.value.start) / (1000 * 60 * 60 * 24);
                return labelWidth + daysDiff * pixelsPerDay.value;
            }

            function getDateY(date) {
                if (!projectDuration.value.start) return verticalHeaderHeight;
                const d = typeof date === 'string' ? new Date(date) : date;
                const daysDiff = (d - projectDuration.value.start) / (1000 * 60 * 60 * 24);
                return verticalHeaderHeight + daysDiff * pixelsPerDay.value;
            }

            function getMilestonePoints(cx, cy) {
                const size = 8;
                return `${cx},${cy-size} ${cx+size},${cy} ${cx},${cy+size} ${cx-size},${cy}`;
            }

            function getElementeForGruppe(gruppeId) {
                if (!currentProject.value) return [];
                return sortedElemente.value.filter(e => e.gruppe === gruppeId);
            }

            function createProject() {
                const today = new Date();
                const startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                const endDate = new Date(today.getFullYear() + 1, today.getMonth(), 0);

                const newProject = {
                    id: generateId(),
                    projekt: {
                        name: 'Neues Projekt',
                        beschreibung: '',
                        start: startDate.toISOString().split('T')[0],
                        ende: endDate.toISOString().split('T')[0]
                    },
                    gruppen: [
                        { id: generateId(), name: 'Phasenplan', reihenfolge: 1 }
                    ],
                    elemente: [],
                    einstellungen: {
                        heuteAnzeigen: true,
                        legendeAnzeigen: true,
                        zeitskala: 'monat',
                        farbNamen: {
                            gruen: 'Vorbereitung',
                            rot: 'Plandauer',
                            dunkelrot: 'Kritisch'
                        }
                    }
                };

                projects.value.push(newProject);
                currentProjectId.value = newProject.id;
                saveToStorage();
            }

            function selectProject(id) {
                currentProjectId.value = id;
            }

            function duplicateProject() {
                if (!currentProject.value) return;
                const copy = JSON.parse(JSON.stringify(currentProject.value));
                copy.id = generateId();
                copy.projekt.name = copy.projekt.name + ' (Kopie)';

                // Generate new IDs
                const idMap = {};
                copy.gruppen.forEach(g => {
                    const oldId = g.id;
                    g.id = generateId();
                    idMap[oldId] = g.id;
                });
                copy.elemente.forEach(e => {
                    e.id = generateId();
                    if (e.gruppe && idMap[e.gruppe]) e.gruppe = idMap[e.gruppe];
                });

                projects.value.push(copy);
                currentProjectId.value = copy.id;
                saveToStorage();
            }

            function deleteProject() {
                if (!currentProject.value) return;
                if (!confirm(`Projekt "${currentProject.value.projekt.name}" wirklich löschen?`)) return;
                const index = projects.value.findIndex(p => p.id === currentProjectId.value);
                if (index >= 0) {
                    projects.value.splice(index, 1);
                    currentProjectId.value = projects.value[0]?.id || null;
                    saveToStorage();
                }
            }

            // Template Functions
            function saveAsTemplate() {
                if (!currentProject.value) return;
                newTemplateName.value = currentProject.value.projekt.name + ' (Vorlage)';
                showSaveTemplateModal.value = true;
            }

            function confirmSaveTemplate() {
                if (!currentProject.value || !newTemplateName.value.trim()) return;

                const template = {
                    id: generateId(),
                    name: newTemplateName.value.trim(),
                    erstelltAm: new Date().toISOString().split('T')[0],
                    // Store relative days from project start for each element
                    projektDauer: getDaysBetween(currentProject.value.projekt.start, currentProject.value.projekt.ende),
                    gruppen: JSON.parse(JSON.stringify(currentProject.value.gruppen)),
                    elemente: currentProject.value.elemente.map(e => {
                        const copy = JSON.parse(JSON.stringify(e));
                        // Convert absolute dates to relative days from project start
                        if (e.typ === 'phase') {
                            copy.startTag = getDaysBetween(currentProject.value.projekt.start, e.start);
                            copy.endeTag = getDaysBetween(currentProject.value.projekt.start, e.ende);
                            delete copy.start;
                            delete copy.ende;
                        } else {
                            copy.datumTag = getDaysBetween(currentProject.value.projekt.start, e.datum);
                            delete copy.datum;
                        }
                        return copy;
                    }),
                    einstellungen: JSON.parse(JSON.stringify(currentProject.value.einstellungen))
                };

                templates.value.push(template);
                saveTemplatesToStorage();
                showSaveTemplateModal.value = false;
                newTemplateName.value = '';
                alert('Vorlage "' + template.name + '" gespeichert!');
            }

            function createFromTemplate(template) {
                const today = new Date();
                const startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                const endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + (template.projektDauer || 180));

                // Generate new IDs for groups
                const gruppenIdMap = {};
                const newGruppen = template.gruppen.map(g => {
                    const newId = generateId();
                    gruppenIdMap[g.id] = newId;
                    return { ...g, id: newId };
                });

                // Generate new IDs for elements and convert relative days back to dates
                const newElemente = template.elemente.map(e => {
                    const copy = { ...e, id: generateId() };
                    if (copy.gruppe && gruppenIdMap[copy.gruppe]) {
                        copy.gruppe = gruppenIdMap[copy.gruppe];
                    }
                    if (e.typ === 'phase') {
                        copy.start = addDaysToDate(startDate, e.startTag || 0);
                        copy.ende = addDaysToDate(startDate, e.endeTag || 30);
                        delete copy.startTag;
                        delete copy.endeTag;
                    } else {
                        copy.datum = addDaysToDate(startDate, e.datumTag || 0);
                        delete copy.datumTag;
                    }
                    return copy;
                });

                const newProject = {
                    id: generateId(),
                    projekt: {
                        name: 'Neues Projekt (aus ' + template.name + ')',
                        beschreibung: '',
                        start: startDate.toISOString().split('T')[0],
                        ende: endDate.toISOString().split('T')[0]
                    },
                    gruppen: newGruppen,
                    elemente: newElemente,
                    einstellungen: template.einstellungen ? JSON.parse(JSON.stringify(template.einstellungen)) : {
                        heuteAnzeigen: true,
                        legendeAnzeigen: true,
                        zeitskala: 'monat'
                    }
                };

                projects.value.push(newProject);
                currentProjectId.value = newProject.id;
                saveToStorage();
            }

            function deleteTemplate(id) {
                const template = templates.value.find(t => t.id === id);
                if (!confirm(`Vorlage "${template?.name}" wirklich löschen?`)) return;
                const index = templates.value.findIndex(t => t.id === id);
                if (index >= 0) {
                    templates.value.splice(index, 1);
                    saveTemplatesToStorage();
                }
            }

            function exportTemplateAsJson(template) {
                const json = JSON.stringify(template, null, 2);
                navigator.clipboard.writeText(json)
                    .then(() => alert('Vorlage-JSON in Zwischenablage kopiert'))
                    .catch(e => alert('Kopieren fehlgeschlagen: ' + e.message));
            }

            function importTemplateFromJson() {
                const jsonStr = prompt('Vorlage-JSON einfügen:');
                if (!jsonStr) return;
                try {
                    const imported = JSON.parse(jsonStr);
                    if (!imported.name || !imported.gruppen) {
                        throw new Error('Ungültiges Vorlagenformat');
                    }
                    imported.id = generateId();
                    imported.erstelltAm = new Date().toISOString().split('T')[0];
                    templates.value.push(imported);
                    saveTemplatesToStorage();
                    alert('Vorlage "' + imported.name + '" importiert!');
                } catch (e) {
                    alert('Import fehlgeschlagen: ' + e.message);
                }
            }

            function getDaysBetween(startStr, endStr) {
                const start = new Date(startStr);
                const end = new Date(endStr);
                return Math.round((end - start) / (1000 * 60 * 60 * 24));
            }

            function addDaysToDate(date, days) {
                const result = new Date(date);
                result.setDate(result.getDate() + days);
                return result.toISOString().split('T')[0];
            }

            function saveTemplatesToStorage() {
                localStorage.setItem('timelineGenerator_templates', JSON.stringify(templates.value));
            }

            function loadTemplatesFromStorage() {
                try {
                    const saved = localStorage.getItem('timelineGenerator_templates');
                    if (saved) {
                        templates.value = JSON.parse(saved);
                    }
                } catch (e) {
                    console.error('Error loading templates:', e);
                }
            }

            function addGruppe() {
                if (!currentProject.value) return;
                const nextOrder = Math.max(0, ...currentProject.value.gruppen.map(g => g.reihenfolge)) + 1;
                currentProject.value.gruppen.push({
                    id: generateId(),
                    name: 'Neue Gruppe',
                    reihenfolge: nextOrder
                });
                saveToStorage();
            }

            function moveGruppe(gruppe, direction) {
                const gruppen = currentProject.value.gruppen;
                const sorted = [...gruppen].sort((a, b) => a.reihenfolge - b.reihenfolge);
                const currentIndex = sorted.findIndex(g => g.id === gruppe.id);
                const newIndex = currentIndex + direction;

                if (newIndex >= 0 && newIndex < sorted.length) {
                    const other = sorted[newIndex];
                    const tempOrder = gruppe.reihenfolge;
                    gruppe.reihenfolge = other.reihenfolge;
                    other.reihenfolge = tempOrder;
                    saveToStorage();
                }
            }

            function deleteGruppe(id) {
                if (!currentProject.value) return;
                const gruppe = currentProject.value.gruppen.find(g => g.id === id);
                if (!confirm(`Gruppe "${gruppe?.name}" wirklich löschen? Elemente werden nicht gelöscht.`)) return;
                const index = currentProject.value.gruppen.findIndex(g => g.id === id);
                if (index >= 0) {
                    currentProject.value.gruppen.splice(index, 1);
                    // Clear gruppe references
                    currentProject.value.elemente.forEach(e => { if (e.gruppe === id) e.gruppe = ''; });
                    saveToStorage();
                }
            }

            function addElement(typ) {
                if (!currentProject.value) return;
                const today = new Date();
                const nextOrder = Math.max(0, ...currentProject.value.elemente.map(e => e.reihenfolge)) + 1;
                const defaultGruppe = sortedGruppen.value[0]?.id || '';

                if (typ === 'phase') {
                    const endDate = new Date(today);
                    endDate.setMonth(endDate.getMonth() + 1);
                    currentProject.value.elemente.push({
                        id: generateId(),
                        typ: 'phase',
                        name: 'Neue Phase',
                        gruppe: defaultGruppe,
                        einrueckung: 0,
                        start: today.toISOString().split('T')[0],
                        ende: endDate.toISOString().split('T')[0],
                        kritisch: false,
                        pufferTage: 0,
                        farbe: 'rot',
                        reihenfolge: nextOrder
                    });
                } else {
                    currentProject.value.elemente.push({
                        id: generateId(),
                        typ: 'meilenstein',
                        name: 'Neuer Meilenstein',
                        gruppe: defaultGruppe,
                        einrueckung: 0,
                        datum: today.toISOString().split('T')[0],
                        reihenfolge: nextOrder
                    });
                }
                saveToStorage();
                // Auto-expand new element in compact view
                expandedElementId.value = currentProject.value.elemente[currentProject.value.elemente.length - 1].id;
            }

            // Element-Ansicht Funktionen
            function toggleElementExpand(elementId) {
                expandedElementId.value = expandedElementId.value === elementId ? null : elementId;
            }

            function toggleGroupCollapse(gruppeId) {
                if (collapsedGroups.value.has(gruppeId)) {
                    collapsedGroups.value.delete(gruppeId);
                } else {
                    collapsedGroups.value.add(gruppeId);
                }
            }

            function isGroupCollapsed(gruppeId) {
                return collapsedGroups.value.has(gruppeId);
            }

            function getElementSummary(element) {
                if (element.typ === 'phase') {
                    return `${formatDateShort(element.start)} - ${formatDateShort(element.ende)}`;
                } else {
                    return formatDateShort(element.datum);
                }
            }

            // Panel Resize Funktionen
            function startResize(event) {
                isResizing.value = true;
                document.addEventListener('mousemove', doResize);
                document.addEventListener('mouseup', stopResize);
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
            }

            function doResize(event) {
                if (!isResizing.value) return;
                const sidebar = document.querySelector('.sidebar-width');
                if (!sidebar) return;
                const sidebarRect = sidebar.getBoundingClientRect();
                const newWidth = event.clientX - sidebarRect.left;
                editorPanelWidth.value = Math.max(minPanelWidth, Math.min(maxPanelWidth, newWidth));
            }

            function stopResize() {
                isResizing.value = false;
                document.removeEventListener('mousemove', doResize);
                document.removeEventListener('mouseup', stopResize);
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
            }

            function moveElement(element, direction) {
                const elemente = currentProject.value.elemente;
                const sameGruppe = elemente.filter(e => e.gruppe === element.gruppe).sort((a, b) => a.reihenfolge - b.reihenfolge);
                const currentIndex = sameGruppe.findIndex(e => e.id === element.id);
                const newIndex = currentIndex + direction;

                if (newIndex >= 0 && newIndex < sameGruppe.length) {
                    const other = sameGruppe[newIndex];
                    const tempOrder = element.reihenfolge;
                    element.reihenfolge = other.reihenfolge;
                    other.reihenfolge = tempOrder;
                    saveToStorage();
                }
            }

            function deleteElement(id) {
                if (!currentProject.value) return;
                const index = currentProject.value.elemente.findIndex(e => e.id === id);
                if (index >= 0) {
                    currentProject.value.elemente.splice(index, 1);
                    saveToStorage();
                }
            }

            function duplicateElement(element) {
                if (!currentProject.value) return;
                const copy = JSON.parse(JSON.stringify(element));
                copy.id = generateId();
                copy.name = element.name + ' (Kopie)';
                copy.reihenfolge = Math.max(0, ...currentProject.value.elemente.map(e => e.reihenfolge)) + 1;
                currentProject.value.elemente.push(copy);
                saveToStorage();
            }

            // Batch-Eingabe
            function openBatchInput() {
                batchInputText.value = '';
                batchInputGruppe.value = sortedGruppen.value[0]?.id || '';
                showBatchInputModal.value = true;
            }

            function parseDate(dateStr) {
                if (!dateStr) return null;
                // Try YYYY-MM-DD format
                if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                    return dateStr;
                }
                // Try DD.MM.YYYY format
                const match = dateStr.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);
                if (match) {
                    const [_, day, month, year] = match;
                    return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                }
                return null;
            }

            function processBatchInput() {
                if (!currentProject.value || !batchInputText.value.trim()) return;

                const lines = batchInputText.value.trim().split('\n');
                let addedCount = 0;
                const errors = [];

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;

                    const parts = line.split(';').map(p => p.trim());
                    const typ = parts[0]?.toLowerCase();

                    if (typ === 'phase') {
                        // phase;Name;Start;Ende;Farbe;Puffer;Kritisch
                        const name = parts[1] || 'Neue Phase';
                        const start = parseDate(parts[2]);
                        const ende = parseDate(parts[3]);
                        const farbe = ['gruen', 'rot', 'dunkelrot'].includes(parts[4]) ? parts[4] : 'rot';
                        const puffer = parseInt(parts[5]) || 0;
                        const kritisch = parts[6]?.toLowerCase() === 'ja';

                        if (!start || !ende) {
                            errors.push(`Zeile ${i + 1}: Ungültiges Datum für Phase "${name}"`);
                            continue;
                        }

                        const nextOrder = Math.max(0, ...currentProject.value.elemente.map(e => e.reihenfolge)) + 1;
                        currentProject.value.elemente.push({
                            id: generateId(),
                            typ: 'phase',
                            name: name,
                            gruppe: batchInputGruppe.value,
                            einrueckung: 0,
                            start: start,
                            ende: ende,
                            kritisch: kritisch,
                            pufferTage: puffer,
                            farbe: farbe,
                            reihenfolge: nextOrder
                        });
                        addedCount++;
                    } else if (typ === 'meilenstein' || typ === 'ms') {
                        // meilenstein;Name;Datum
                        const name = parts[1] || 'Neuer Meilenstein';
                        const datum = parseDate(parts[2]);

                        if (!datum) {
                            errors.push(`Zeile ${i + 1}: Ungültiges Datum für Meilenstein "${name}"`);
                            continue;
                        }

                        const nextOrder = Math.max(0, ...currentProject.value.elemente.map(e => e.reihenfolge)) + 1;
                        currentProject.value.elemente.push({
                            id: generateId(),
                            typ: 'meilenstein',
                            name: name,
                            gruppe: batchInputGruppe.value,
                            einrueckung: 0,
                            datum: datum,
                            reihenfolge: nextOrder
                        });
                        addedCount++;
                    } else if (typ) {
                        errors.push(`Zeile ${i + 1}: Unbekannter Typ "${typ}"`);
                    }
                }

                saveToStorage();
                showBatchInputModal.value = false;

                let message = `${addedCount} Element(e) hinzugefügt.`;
                if (errors.length > 0) {
                    message += '\n\nFehler:\n' + errors.join('\n');
                }
                alert(message);
            }

            // Drag & Drop Funktionen
            function onDragStart(event, element) {
                draggedElement.value = element;
                event.target.classList.add('dragging');
                event.dataTransfer.effectAllowed = 'move';
                event.dataTransfer.setData('text/plain', element.id);
            }

            function onDragOver(event, targetElement) {
                event.preventDefault();
                event.dataTransfer.dropEffect = 'move';
                if (draggedElement.value && draggedElement.value.id !== targetElement.id) {
                    dragOverId.value = targetElement.id;
                }
            }

            function onDragLeave(event) {
                // Nur zurücksetzen wenn wir wirklich das Element verlassen
                if (!event.currentTarget.contains(event.relatedTarget)) {
                    dragOverId.value = null;
                }
            }

            function onDrop(event, targetElement) {
                event.preventDefault();
                dragOverId.value = null;

                if (!draggedElement.value || !currentProject.value) return;
                if (draggedElement.value.id === targetElement.id) return;

                const elemente = currentProject.value.elemente;
                const draggedIdx = elemente.findIndex(e => e.id === draggedElement.value.id);
                const targetIdx = elemente.findIndex(e => e.id === targetElement.id);

                if (draggedIdx === -1 || targetIdx === -1) return;

                // Element an neue Position verschieben
                const [removed] = elemente.splice(draggedIdx, 1);
                elemente.splice(targetIdx, 0, removed);

                // Reihenfolge neu berechnen
                elemente.forEach((el, idx) => {
                    el.reihenfolge = idx + 1;
                });

                // Wenn in andere Gruppe gezogen, Gruppe übernehmen
                if (draggedElement.value.gruppe !== targetElement.gruppe) {
                    draggedElement.value.gruppe = targetElement.gruppe;
                }

                saveToStorage();
                draggedElement.value = null;
            }

            function onDragEnd(event) {
                event.target.classList.remove('dragging');
                draggedElement.value = null;
                dragOverId.value = null;
            }

            function saveToStorage() {
                localStorage.setItem('timelineGenerator_projects_v2', JSON.stringify(projects.value));
                localStorage.setItem('timelineGenerator_currentId_v2', currentProjectId.value);
            }

            function loadFromStorage() {
                try {
                    const savedProjects = localStorage.getItem('timelineGenerator_projects_v2');
                    const savedCurrentId = localStorage.getItem('timelineGenerator_currentId_v2');
                    if (savedProjects) {
                        projects.value = JSON.parse(savedProjects);
                    }
                    if (savedCurrentId && projects.value.find(p => p.id === savedCurrentId)) {
                        currentProjectId.value = savedCurrentId;
                    }
                } catch (e) {
                    console.error('Error loading from storage:', e);
                }
            }

            async function exportTimeline() {
                const format = exportSettings.value.format;

                if (format === 'svg') {
                    exportAsSvg();
                } else {
                    await exportAsPng();
                }
                showExportModal.value = false;
            }

            function exportAsSvg() {
                const container = timelineContainer.value;
                if (!container) return;

                // Clone the container
                const clone = container.cloneNode(true);
                const svg = clone.querySelector('svg');

                // Add necessary styles inline
                const styleElement = document.createElementNS('http://www.w3.org/2000/svg', 'style');
                styleElement.textContent = `
                    .buffer-line { stroke-dasharray: 8, 4; stroke-width: 3; fill: none; }
                    .critical-marker { stroke: #991B1B; stroke-width: 2; }
                    .today-line { stroke: #1F2937; stroke-width: 2; }
                    .grid-line { stroke: #D1D5DB; stroke-width: 1; }
                    .grid-line-light { stroke: #E5E7EB; stroke-width: 0.5; }
                `;
                svg.insertBefore(styleElement, svg.firstChild);

                const serializer = new XMLSerializer();
                let source = serializer.serializeToString(svg);
                source = '<?xml version="1.0" standalone="no"?>\r\n' + source;

                const blob = new Blob([source], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(blob);

                const link = document.createElement('a');
                link.href = url;
                link.download = `${currentProject.value.projekt.name}_timeline.svg`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }

            async function exportAsPng() {
                const container = timelineContainer.value;
                if (!container) return;

                try {
                    const canvas = await html2canvas(container, {
                        backgroundColor: '#FFFFFF',
                        scale: exportSettings.value.scale
                    });

                    const link = document.createElement('a');
                    link.href = canvas.toDataURL('image/png');
                    link.download = `${currentProject.value.projekt.name}_timeline.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } catch (e) {
                    console.error('Export error:', e);
                    alert('Export fehlgeschlagen: ' + e.message);
                }
            }

            function copyJsonToClipboard() {
                if (!currentProject.value) return;
                const json = JSON.stringify(currentProject.value, null, 2);
                navigator.clipboard.writeText(json)
                    .then(() => alert('JSON in Zwischenablage kopiert'))
                    .catch(e => alert('Kopieren fehlgeschlagen: ' + e.message));
            }

            function importFromJson() {
                if (!jsonDataInput.value) return;

                try {
                    const imported = JSON.parse(jsonDataInput.value);
                    if (!imported.projekt || !imported.gruppen) {
                        throw new Error('Ungültiges Projektformat');
                    }
                    imported.id = generateId();
                    projects.value.push(imported);
                    currentProjectId.value = imported.id;
                    saveToStorage();
                    showImportExportModal.value = false;
                    alert('Projekt erfolgreich importiert');
                } catch (e) {
                    alert('Import fehlgeschlagen: ' + e.message);
                }
            }

            // CSV Import
            function handleCsvFileSelect(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    importFromCsv(e.target.result);
                };
                reader.readAsText(file);
                event.target.value = ''; // Reset file input
            }

            function importFromCsv(csvContent) {
                if (!csvContent.trim()) return;

                // Detect delimiter (semicolon or comma)
                const firstLine = csvContent.split('\n')[0];
                const delimiter = firstLine.includes(';') ? ';' : ',';

                const lines = csvContent.trim().split('\n');
                if (lines.length < 2) {
                    alert('CSV muss mindestens eine Kopfzeile und eine Datenzeile enthalten');
                    return;
                }

                // Parse header
                const header = lines[0].split(delimiter).map(h => h.trim().toLowerCase());
                const requiredCols = ['typ', 'name'];
                for (const col of requiredCols) {
                    if (!header.includes(col)) {
                        alert(`CSV fehlt erforderliche Spalte: ${col}`);
                        return;
                    }
                }

                // Build column index map
                const colIndex = {};
                header.forEach((col, idx) => colIndex[col] = idx);

                // Create new project
                const today = new Date();
                const newProject = {
                    id: generateId(),
                    projekt: {
                        name: 'CSV Import',
                        beschreibung: '',
                        start: '',
                        ende: ''
                    },
                    gruppen: [],
                    elemente: [],
                    einstellungen: {
                        heuteAnzeigen: true,
                        legendeAnzeigen: true,
                        zeitskala: 'monat',
                        farbNamen: {
                            gruen: 'Vorbereitung',
                            rot: 'Plandauer',
                            dunkelrot: 'Kritisch'
                        }
                    }
                };

                // Track groups by name
                const gruppenMap = {};
                let minDate = null;
                let maxDate = null;
                let orderCounter = 1;
                const errors = [];

                // First pass: create groups
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;

                    const parts = line.split(delimiter).map(p => p.trim());
                    const typ = (parts[colIndex['typ']] || '').toLowerCase();
                    const name = parts[colIndex['name']] || '';

                    if (typ === 'gruppe' && name) {
                        if (!gruppenMap[name]) {
                            const gruppeId = generateId();
                            gruppenMap[name] = gruppeId;
                            newProject.gruppen.push({
                                id: gruppeId,
                                name: name,
                                reihenfolge: newProject.gruppen.length + 1
                            });
                        }
                    }
                }

                // Second pass: create elements
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;

                    const parts = line.split(delimiter).map(p => p.trim());
                    const typ = (parts[colIndex['typ']] || '').toLowerCase();
                    const name = parts[colIndex['name']] || '';
                    const gruppeName = parts[colIndex['gruppe']] || '';
                    const gruppeId = gruppenMap[gruppeName] || '';

                    if (typ === 'phase') {
                        const startStr = parts[colIndex['start']] || '';
                        const endeStr = parts[colIndex['ende']] || '';
                        const start = parseDate(startStr);
                        const ende = parseDate(endeStr);

                        if (!start || !ende) {
                            errors.push(`Zeile ${i + 1}: Ungültiges Datum für Phase "${name}"`);
                            continue;
                        }

                        const farbe = ['gruen', 'rot', 'dunkelrot'].includes(parts[colIndex['farbe']])
                            ? parts[colIndex['farbe']] : 'rot';
                        const puffer = parseInt(parts[colIndex['puffer']]) || 0;
                        const kritisch = (parts[colIndex['kritisch']] || '').toLowerCase() === 'ja';
                        const einrueckung = parseInt(parts[colIndex['einrückung']] || parts[colIndex['einrueckung']]) || 0;

                        newProject.elemente.push({
                            id: generateId(),
                            typ: 'phase',
                            name: name,
                            gruppe: gruppeId,
                            einrueckung: Math.min(2, Math.max(0, einrueckung)),
                            start: start,
                            ende: ende,
                            kritisch: kritisch,
                            pufferTage: puffer,
                            farbe: farbe,
                            reihenfolge: orderCounter++
                        });

                        // Track min/max dates
                        const startDate = new Date(start);
                        const endDate = new Date(ende);
                        if (!minDate || startDate < minDate) minDate = startDate;
                        if (!maxDate || endDate > maxDate) maxDate = endDate;

                    } else if (typ === 'meilenstein' || typ === 'ms') {
                        const datumStr = parts[colIndex['start']] || parts[colIndex['datum']] || '';
                        const datum = parseDate(datumStr);

                        if (!datum) {
                            errors.push(`Zeile ${i + 1}: Ungültiges Datum für Meilenstein "${name}"`);
                            continue;
                        }

                        const einrueckung = parseInt(parts[colIndex['einrückung']] || parts[colIndex['einrueckung']]) || 0;

                        newProject.elemente.push({
                            id: generateId(),
                            typ: 'meilenstein',
                            name: name,
                            gruppe: gruppeId,
                            einrueckung: Math.min(2, Math.max(0, einrueckung)),
                            datum: datum,
                            reihenfolge: orderCounter++
                        });

                        const datumDate = new Date(datum);
                        if (!minDate || datumDate < minDate) minDate = datumDate;
                        if (!maxDate || datumDate > maxDate) maxDate = datumDate;
                    }
                }

                // Set project dates
                if (minDate && maxDate) {
                    newProject.projekt.start = minDate.toISOString().split('T')[0];
                    // Add some buffer to end date
                    maxDate.setDate(maxDate.getDate() + 30);
                    newProject.projekt.ende = maxDate.toISOString().split('T')[0];
                } else {
                    newProject.projekt.start = today.toISOString().split('T')[0];
                    const endDate = new Date(today);
                    endDate.setFullYear(endDate.getFullYear() + 1);
                    newProject.projekt.ende = endDate.toISOString().split('T')[0];
                }

                // Add project
                projects.value.push(newProject);
                currentProjectId.value = newProject.id;
                saveToStorage();
                showImportExportModal.value = false;

                let message = `CSV-Import erfolgreich!\n${newProject.gruppen.length} Gruppe(n), ${newProject.elemente.length} Element(e) erstellt.`;
                if (errors.length > 0) {
                    message += '\n\nWarnungen:\n' + errors.slice(0, 5).join('\n');
                    if (errors.length > 5) {
                        message += `\n... und ${errors.length - 5} weitere`;
                    }
                }
                alert(message);
            }

            function downloadCsvTemplate() {
                const template = `Typ;Name;Gruppe;Start;Ende;Farbe;Puffer;Kritisch;Einrückung
gruppe;Phasenplan;;;;;;;;
phase;Analyse;Phasenplan;2025-01-01;2025-01-31;gruen;0;nein;0
phase;Konzeption;Phasenplan;2025-02-01;2025-02-28;rot;14;ja;1
meilenstein;Kickoff;Phasenplan;2025-01-15;;;;;0
gruppe;Workstreams;;;;;;;;
phase;Stream A;Workstreams;2025-01-01;2025-03-31;gruen;0;nein;0`;

                const blob = new Blob([template], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'timeline_vorlage.csv';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }

            // Lifecycle
            onMounted(() => {
                loadFromStorage();
                loadTemplatesFromStorage();
                if (projects.value.length === 0) {
                    createProject();
                }
            });

            return {
                projects,
                templates,
                currentProject,
                currentProjectId,
                activeTab,
                elementeView,
                expandedElementId,
                collapsedGroups,
                editorPanelWidth,
                isResizing,
                sortedGruppen,
                sortedElemente,
                usedColors,
                hasBuffer,
                hasMilestones,
                hasCritical,
                dragOverId,
                rowHeight,
                labelWidth,
                canvasWidth,
                canvasHeight,
                yearPeriods,
                timePeriods,
                timelineRows,
                todayX,
                showExportModal,
                showImportExportModal,
                showTemplatesModal,
                showSaveTemplateModal,
                newTemplateName,
                exportSettings,
                jsonDataInput,
                timelineContainer,
                timelineSvg,
                showBatchInputModal,
                batchInputText,
                batchInputGruppe,
                darkMode,
                showExecutiveSummary,
                verticalMode,
                themeColors,
                displayRows,
                verticalCanvasWidth,
                verticalCanvasHeight,
                verticalTimePeriods,
                verticalElements,
                todayY,
                formatDateShort,
                getElementeForGruppe,
                getMilestonePoints,
                createProject,
                selectProject,
                duplicateProject,
                deleteProject,
                saveAsTemplate,
                confirmSaveTemplate,
                createFromTemplate,
                deleteTemplate,
                exportTemplateAsJson,
                importTemplateFromJson,
                addGruppe,
                moveGruppe,
                deleteGruppe,
                addElement,
                toggleElementExpand,
                toggleGroupCollapse,
                isGroupCollapsed,
                getElementSummary,
                startResize,
                moveElement,
                deleteElement,
                duplicateElement,
                openBatchInput,
                processBatchInput,
                onDragStart,
                onDragOver,
                onDragLeave,
                onDrop,
                onDragEnd,
                exportTimeline,
                copyJsonToClipboard,
                importFromJson,
                handleCsvFileSelect,
                downloadCsvTemplate,
                saveToStorage
            };
        }
    }).mount('#app');
    </script>
</body>
</html>
